<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Executivo de Infraestrutura, RH e Utilidades</title>
    
    <!-- Dependências do Tailwind e Ícones -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Dependências do Chart.js (Aba Infra) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <!-- Dependências do React e Recharts (Aba Utilidades) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Dependências do Leaflet (Mapas em todas as abas) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* ESTILOS COMPARTILHADOS E ABA INFRA */
        .status-badge { @apply px-2 py-0.5 rounded-full text-[10px] font-semibold whitespace-nowrap border; }
        .sit-adequada { @apply bg-green-600 text-white border-green-700 shadow-sm; }
        .sit-inadequada { @apply bg-orange-400 text-white border-orange-500 shadow-sm; }
        .sit-nao-ocupado { @apply bg-red-600 text-white border-red-700 shadow-sm; }
        .sit-contratacao { @apply bg-blue-500 text-white border-blue-600 shadow-sm; }
        
        .bg-ok { @apply bg-green-100 text-green-800 border-green-200; }
        .bg-warning { @apply bg-yellow-100 text-yellow-800 border-yellow-200; }
        .bg-error { @apply bg-red-100 text-red-800 border-red-200; }
        .bg-neutral { @apply bg-slate-100 text-slate-500 border-slate-200; }
        
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* Ajuste do Mapa Vanilla para ser Quadrado e Centralizado */
        .map-container-square {
            width: 100%;
            max-width: 800px; /* Limita largura para não ficar gigante */
            aspect-ratio: 1 / 1; /* Garante ser quadrado */
            margin: 0 auto;
            position: relative;
        }
        #map { height: 100%; width: 100%; border-radius: 1.5rem; z-index: 10; }
        
        /* Label do mapa da Aba Infra (Vanilla JS) */
        .city-label { 
            background: rgba(255, 255, 255, 0.85) !important; 
            border: 1px solid #cbd5e1 !important; 
            border-radius: 4px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important; 
            font-weight: 700 !important; 
            font-size: 10px !important; 
            color: #0f172a !important; 
            white-space: nowrap; 
            padding: 2px 6px !important;
            margin-top: -5px !important;
        }
        .city-label::before { display: none; }
        
        th.sortable { cursor: pointer; transition: background 0.2s; position: relative; }
        th.sortable:hover { @apply bg-slate-800; }
        .sort-icon { display: inline-block; margin-left: 4px; opacity: 0.3; }
        th.active-sort .sort-icon { opacity: 1; color: #3b82f6; }
        
        /* ESTILOS DAS ABAS PRINCIPAIS */
        .tab-box { 
            @apply px-6 py-3 rounded-lg border-2 border-slate-200 font-bold transition-all uppercase text-xs tracking-widest bg-white;
            color: #64748b; 
        }
        .tab-box.active { 
            @apply border-slate-900 bg-slate-50 shadow-md;
            color: #1e293b; 
        }
        .tab-infra { border-left-color: #3b82f6; }
        .tab-infra.active { background-color: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }
        .tab-rh { border-left-color: #10b981; }
        .tab-rh.active { background-color: #f0fdf4; border-color: #10b981; color: #047857; }
        .tab-util { border-left-color: #f59e0b; }
        .tab-util.active { background-color: #fffbeb; border-color: #f59e0b; color: #b45309; }
        .tab-links { border-left-color: #8b5cf6; }
        .tab-links.active { background-color: #f5f3ff; border-color: #8b5cf6; color: #7c3aed; }

        .map-legend {
            position: absolute; bottom: 20px; right: 20px; z-index: 1000;
            background: white; padding: 10px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 10px;
            font-weight: bold; display: flex; flex-direction: column;
            gap: 6px; border: 1px solid #e2e8f0;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; text-transform: uppercase; }
        .legend-color { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); }
        .percent-badge { @apply w-10 h-10 rounded-full flex items-center justify-center text-xs font-bold border-2; transition: all 0.2s; }

        /* ESTILOS ABA REACT/RECHARTS */
        .recharts-default-tooltip { border-radius: 12px !important; border: none !important; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1) !important; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-active-react { background-color: #005fb2 !important; color: white !important; }
        .leaflet-container { z-index: 0; border-radius: 1.5rem; font-family: 'Inter', sans-serif; }
        .custom-map-marker { background: transparent; border: none; }
        .custom-leaflet-tooltip { border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); padding: 0.5rem; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div class="max-w-[1650px] mx-auto px-4 py-8">
        <!-- CABEÇALHO GLOBAL -->
        <header class="mb-6 border-b border-slate-200 pb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <span class="bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase">Interno</span>
                    <h1 class="text-3xl font-bold text-slate-800 tracking-tight uppercase">Gestão dos Escritórios</h1>
                </div>
                <p class="text-slate-500">Acompanhamento de Utilidades, Infraestrutura, Vagas e Pessoas</p>
            </div>
        </header>

        <!-- NAVEGAÇÃO GLOBAL (ABAS) - REORDENADA -->
        <div class="flex flex-wrap gap-4 mb-8">
            <button onclick="switchTab('util')" id="btn-util" class="tab-box tab-util active">Gestão do Aluguel, Energia e Água</button>
            <button onclick="switchTab('infra')" id="btn-infra" class="tab-box tab-infra">Infraestrutura & Mobiliário</button>
            <button onclick="switchTab('rh')" id="btn-rh" class="tab-box tab-rh">Acompanhamento do Quadro de Vagas</button>
            <button onclick="switchTab('links')" id="btn-links" class="tab-box tab-links">Acesso Rápido & Links</button>
        </div>

        <!-- CONTEÚDO 1: GESTÃO DE LOCAÇÕES E UTILIDADES (APLICATIVO REACT) - AGORA O PRIMEIRO -->
        <div id="tab-util-content" class="block">
            <!-- Root para montar a aplicação React do Código 1 -->
            <div id="root-utilidades"></div>
        </div>

        <!-- CONTEÚDO 2: INFRAESTRUTURA -->
        <div id="tab-infra-content" class="hidden">
            
            <!-- Linha 1: Gráficos de Rosca (3 Colunas) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-wider text-center">Situação Geral</h3>
                    <div class="h-[200px] flex justify-center items-center"><canvas id="situationChart"></canvas></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-wider text-center">Natureza Jurídica</h3>
                    <div class="h-[200px] flex justify-center items-center"><canvas id="natureChart"></canvas></div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-wider text-center">Mobiliário</h3>
                    <div class="h-[200px] flex justify-center items-center"><canvas id="mobDetailedChart"></canvas></div>
                </div>
            </div>

            <!-- Linha 2: Gráfico de Atingimento (Em Evidência - Full Width) -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-8">
                <h3 class="text-[11px] font-black text-slate-600 uppercase mb-6 tracking-wider flex items-center gap-2">
                    <i data-lucide="bar-chart-2" class="w-4 h-4 text-blue-500"></i>
                    Atingimento por Serviço (%)
                </h3>
                <div class="h-[250px]"><canvas id="servicesChart"></canvas></div>
            </div>

            <!-- Mapa Infra (Quadrado e Centralizado) -->
            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-200 mb-8 relative">
                <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-wider text-center">Geolocalização das Unidades</h3>
                <div class="map-container-square">
                    <div id="map" class="border border-slate-100 shadow-inner"></div>
                    <div class="map-legend">
                        <div class="legend-item"><span class="legend-color bg-green-600"></span> Adequada</div>
                        <div class="legend-item"><span class="legend-color bg-orange-400"></span> Inadequada</div>
                        <div class="legend-item"><span class="legend-color bg-red-600"></span> Não Ocupado</div>
                        <div class="legend-item"><span class="legend-color bg-blue-500"></span> Contratação</div>
                    </div>
                </div>
            </div>

            <!-- Filtros Infra -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 mb-6 flex flex-wrap gap-4 items-end">
                <div class="flex-1 min-w-[200px]">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Município Sede</label>
                    <select id="municipioFilter" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none cursor-pointer focus:ring-2 focus:ring-blue-500">
                        <option value="all">Todos os Municípios</option>
                    </select>
                </div>
                <div class="w-48">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Natureza Jurídica</label>
                    <select id="natureFilter" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none cursor-pointer focus:ring-2 focus:ring-blue-500">
                        <option value="all">Todas as Naturezas</option>
                        <option value="Coworking">Coworking</option>
                        <option value="Locado - CNPJ">Locado - CNPJ</option>
                        <option value="Locado - CPF">Locado - CPF</option>
                        <option value="Edif. Público">Edifício Público</option>
                    </select>
                </div>
                <div class="w-48">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Situação Final</label>
                    <select id="situacaoFilter" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none cursor-pointer focus:ring-2 focus:ring-blue-500">
                        <option value="all">Todas as Situações</option>
                        <option value="Adequada">Adequada</option>
                        <option value="Inadequada">Inadequada</option>
                        <option value="Não ocupado">Não Ocupado</option>
                        <option value="Contratação">Contratação</option>
                    </select>
                </div>
            </div>

            <!-- Tabela Infra -->
            <div class="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto overflow-y-auto custom-scrollbar max-h-[500px]">
                    <table class="w-full text-left text-[11px] border-separate border-spacing-0" id="infraTable">
                        <thead class="bg-slate-900 text-white uppercase font-bold tracking-wider">
                            <tr>
                                <th class="px-4 py-4 sticky left-0 top-0 bg-slate-900 z-40 border-b border-slate-800 sortable" onclick="handleSort('id')">Município Sede <span class="sort-icon" id="icon-id">↕</span></th>
                                <th class="px-3 py-4 sticky top-0 bg-slate-900 z-30 border-b border-slate-800 sortable" onclick="handleSort('compliance')">Atingimento <span class="sort-icon" id="icon-compliance">↕</span></th>
                                <th class="px-3 py-4 sticky top-0 bg-slate-900 z-30 border-b border-slate-800 sortable" onclick="handleSort('nat')">Natureza <span class="sort-icon" id="icon-nat">↕</span></th>
                                <th class="px-3 py-4 sticky top-0 bg-slate-900 z-30 border-b border-slate-800 sortable" onclick="handleSort('mob')">Mobiliário <span class="sort-icon" id="icon-mob">↕</span></th>
                                <th class="px-3 py-4 sticky top-0 bg-slate-900 z-30 border-b border-slate-800 sortable" onclick="handleSort('lim')">Limpeza <span class="sort-icon" id="icon-lim">↕</span></th>
                                <th class="px-3 py-4 sticky top-0 bg-slate-900 z-30 border-b border-slate-800 sortable" onclick="handleSort('jar')">Jardinagem <span class="sort-icon" id="icon-jar">↕</span></th>
                                <th class="px-3 py-4 sticky top-0 bg-slate-900 z-30 border-b border-slate-800 sortable" onclick="handleSort('int')">Internet <span class="sort-icon" id="icon-int">↕</span></th>
                                <th class="px-3 py-4 sticky top-0 bg-slate-900 z-30 border-b border-slate-800 sortable" onclick="handleSort('tel')">Telefonia <span class="sort-icon" id="icon-tel">↕</span></th>
                                <th class="px-3 py-4 sticky top-0 bg-slate-900 z-30 border-b border-slate-800 sortable" onclick="handleSort('vig')">Vigilância <span class="sort-icon" id="icon-vig">↕</span></th>
                                <th class="px-3 py-4 sticky top-0 bg-slate-900 z-30 border-b border-slate-800 sortable" onclick="handleSort('imp')">Impressão <span class="sort-icon" id="icon-imp">↕</span></th>
                                <th class="px-4 py-4 text-center sticky top-0 bg-slate-900 z-30 border-b border-slate-800">Situação Final</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CONTEÚDO 3: RECURSOS HUMANOS -->
        <div id="tab-rh-content" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 class="text-sm font-bold text-slate-700 mb-6 uppercase tracking-wider flex items-center justify-between">
                        Evolução da Ocupação por Unidade (Total)
                        <span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded">Meta vs Real</span>
                    </h3>
                    <div class="h-[350px]"><canvas id="staffingSummaryChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-center text-center">
                    <div class="mb-4">
                        <span class="text-5xl font-black text-blue-600" id="totalFillPercent">0%</span>
                        <p class="text-xs font-bold text-slate-400 uppercase mt-2">Ocupação Total de Vagas</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-6 border-t pt-6">
                        <div>
                            <span class="text-xl font-bold text-slate-700" id="totalMeta">0</span>
                            <p class="text-[9px] text-slate-400 uppercase">Meta Total</p>
                        </div>
                        <div>
                            <span class="text-xl font-bold text-green-600" id="totalReal">0</span>
                            <p class="text-[9px] text-slate-400 uppercase">Preenchidas</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros RH -->
            <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 mb-6">
                <div class="max-w-md">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Pesquisar Unidade de Gestão</label>
                    <input type="text" id="searchInputRh" placeholder="Filtrar por nome da unidade..." class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- Tabela RH -->
            <div class="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto overflow-y-auto custom-scrollbar max-h-[600px]">
                    <table class="w-full text-left text-[11px] border-separate border-spacing-0" id="rhTable">
                        <thead class="bg-slate-900 text-white uppercase font-bold tracking-wider">
                            <tr>
                                <th class="px-4 py-4 sticky left-0 top-0 bg-slate-900 z-40 border-b border-slate-800 sortable" onclick="handleSortRh('id')">Unidade de Gestão <span class="sort-icon" id="icon-rh-id">↕</span></th>
                                <th class="px-3 py-4 sticky top-0 bg-slate-900 z-30 border-b border-slate-800 text-center sortable" onclick="handleSortRh('mSup')">Superior (Meta) <span class="sort-icon" id="icon-rh-mSup">↕</span></th>
                                <th class="px-3 py-4 sticky top-0 bg-slate-900 z-30 border-b border-slate-800 text-center sortable" onclick="handleSortRh('rSup')">Superior (Real) <span class="sort-icon" id="icon-rh-rSup">↕</span></th>
                                <th class="px-3 py-4 sticky top-0 bg-slate-900 z-30 border-b border-slate-800 text-center sortable" onclick="handleSortRh('mMed')">Médio (Meta) <span class="sort-icon" id="icon-rh-mMed">↕</span></th>
                                <th class="px-3 py-4 sticky top-0 bg-slate-900 z-30 border-b border-slate-800 text-center sortable" onclick="handleSortRh('rMed')">Médio (Real) <span class="sort-icon" id="icon-rh-rMed">↕</span></th>
                                <th class="px-3 py-4 sticky top-0 bg-slate-900 z-30 border-b border-slate-800 text-center bg-slate-800 sortable" onclick="handleSortRh('totalMeta')">Total Meta <span class="sort-icon" id="icon-rh-totalMeta">↕</span></th>
                                <th class="px-3 py-4 sticky top-0 bg-slate-900 z-30 border-b border-slate-800 text-center bg-slate-800 sortable" onclick="handleSortRh('totalReal')">Total Real <span class="sort-icon" id="icon-rh-totalReal">↕</span></th>
                                <th class="px-4 py-4 text-center sticky top-0 bg-slate-900 z-30 border-b border-slate-800 sortable" onclick="handleSortRh('isFull')">Vagas Preenchidas? <span class="sort-icon" id="icon-rh-isFull">↕</span></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CONTEÚDO 4: LINKS E ACESSO RÁPIDO -->
        <div id="tab-links-content" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Trello -->
                <a href="https://trello.com/b/xt42M1Ns/quadro-gestao-coes" target="_blank" class="group bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-lg hover:border-blue-300 transition-all cursor-pointer flex items-center gap-5">
                    <div class="bg-blue-50 p-4 rounded-xl group-hover:bg-blue-100 transition-colors">
                        <i data-lucide="trello" class="w-8 h-8 text-blue-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800 group-hover:text-blue-700 mb-1">Trello</h3>
                        <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">Quadro Gestão COES</p>
                    </div>
                </a>
                <!-- Orçamento -->
                <a href="https://drive.google.com/drive/u/1/folders/1OoMySo0CRk_XfTPLfDCS3iXlj0HTIgDQ" target="_blank" class="group bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-lg hover:border-green-300 transition-all cursor-pointer flex items-center gap-5">
                    <div class="bg-green-50 p-4 rounded-xl group-hover:bg-green-100 transition-colors">
                        <i data-lucide="dollar-sign" class="w-8 h-8 text-green-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800 group-hover:text-green-700 mb-1">Orçamento</h3>
                        <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">Drive de Finanças</p>
                    </div>
                </a>
                <!-- Apresentações -->
                <a href="https://drive.google.com/drive/u/1/folders/1MMeyrSvAV448UHNdCdVB48uOAhrXFJ4u" target="_blank" class="group bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-lg hover:border-orange-300 transition-all cursor-pointer flex items-center gap-5">
                    <div class="bg-orange-50 p-4 rounded-xl group-hover:bg-orange-100 transition-colors">
                        <i data-lucide="presentation" class="w-8 h-8 text-orange-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800 group-hover:text-orange-700 mb-1">Apresentações</h3>
                        <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">Material Institucional</p>
                    </div>
                </a>
                <!-- Relatório Situacional -->
                <a href="https://lookerstudio.google.com/u/1/reporting/a3763307-dc94-4d56-b8df-a3b93e89d150/page/page_12345/edit" target="_blank" class="group bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-lg hover:border-purple-300 transition-all cursor-pointer flex items-center gap-5">
                    <div class="bg-purple-50 p-4 rounded-xl group-hover:bg-purple-100 transition-colors">
                        <i data-lucide="bar-chart-2" class="w-8 h-8 text-purple-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800 group-hover:text-purple-700 mb-1">Relatório Situacional</h3>
                        <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">Looker Studio</p>
                    </div>
                </a>
                <!-- Planilhas COES -->
                <a href="https://docs.google.com/spreadsheets/d/1uu3oONRu_VGN-5don4E1aN7WuG-Qu0mZ2YBQeq0tTSo/edit?gid=0#gid=0" target="_blank" class="group bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-lg hover:border-teal-300 transition-all cursor-pointer flex items-center gap-5">
                    <div class="bg-teal-50 p-4 rounded-xl group-hover:bg-teal-100 transition-colors">
                        <i data-lucide="table" class="w-8 h-8 text-teal-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800 group-hover:text-teal-700 mb-1">Planilhas COES</h3>
                        <p class="text-xs text-slate-500 font-medium uppercase tracking-wide">Google Sheets</p>
                    </div>
                </a>
            </div>
        </div>

    </div>

    <!-- SCRIPT VANILLA JS (LOGICA DAS ABAS E CONTROLE GLOBAL) -->
    <script>
        // --- CONTROLE DE ABAS ---
        function switchTab(tab) {
            const tabsContent = {
                'util': document.getElementById('tab-util-content'),
                'infra': document.getElementById('tab-infra-content'),
                'rh': document.getElementById('tab-rh-content'),
                'links': document.getElementById('tab-links-content')
            };
            const btns = {
                'util': document.getElementById('btn-util'),
                'infra': document.getElementById('btn-infra'),
                'rh': document.getElementById('btn-rh'),
                'links': document.getElementById('btn-links')
            };

            // Oculta todos e desmarca todos os botões
            Object.keys(tabsContent).forEach(key => {
                if(tabsContent[key]) {
                    tabsContent[key].classList.add('hidden');
                    tabsContent[key].classList.remove('block');
                }
                if(btns[key]) {
                    btns[key].classList.remove('active');
                }
            });

            // Mostra o ativo
            if(tabsContent[tab]) {
                tabsContent[tab].classList.remove('hidden');
                tabsContent[tab].classList.add('block');
            }
            if(btns[tab]) {
                btns[tab].classList.add('active');
            }

            // Gatilhos de redimensionamento e recarga
            if (tab === 'infra' && map) {
                setTimeout(() => map.invalidateSize(), 100);
            } else if (tab === 'rh') {
                renderRhTable();
                initRhCharts();
            } else if (tab === 'util') {
                setTimeout(() => window.dispatchEvent(new Event('resize')), 50);
            } else if (tab === 'links') {
                if(window.lucide) window.lucide.createIcons();
            }
        }

        // --- VARIÁVEIS GLOBAIS DE ESTADO (Infra e RH) ---
        let currentSort = { key: 'id', dir: 'asc' };
        let rhSort = { key: 'id', dir: 'asc' };
        let rhChartInstance = null;
        let map, markersLayer;

        // --- DADOS RECURSOS HUMANOS ---
        const rhData = [
            { id: "Distrital de São Gabriel da Cachoeira/AM", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital Leste de Roraima/RR", mSup: 4, mMed: 1, rSup: 4, rMed: 1 },
            { id: "Distrital Yanomami", mSup: 4, mMed: 2, rSup: 1, rMed: 2 },
            { id: "Regional de Boa Vista/RR", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de Barra do Garças/MT", mSup: 3, mMed: 1, rSup: 1, rMed: 1 },
            { id: "Distrital de Campo Grande/MS", mSup: 4, mMed: 1, rSup: 4, rMed: 1 },
            { id: "Distrital de Canarana/MT", mSup: 3, mMed: 1, rSup: 3, rMed: 0 },
            { id: "Distrital de Colider/MT", mSup: 3, mMed: 1, rSup: 0, rMed: 0 },
            { id: "Distrital de São Félix do Araguaia/MT", mSup: 3, mMed: 1, rSup: 3, rMed: 0 },
            { id: "Distrital de Cuiabá/MT", mSup: 3, mMed: 1, rSup: 1, rMed: 0 },
            { id: "Regional do Centro-Oeste/MT", mSup: 3, mMed: 1, rSup: 1, rMed: 0 },
            { id: "Distrital de Florianópolis/SC", mSup: 3, mMed: 1, rSup: 2, rMed: 0 },
            { id: "Distrital de Curitiba/PR", mSup: 4, mMed: 1, rSup: 0, rMed: 0 },
            { id: "Regional de Curitiba/PR", mSup: 3, mMed: 1, rSup: 1, rMed: 1 },
            { id: "Distrital de Governador Valadares/MG", mSup: 3, mMed: 1, rSup: 3, rMed: 0 },
            { id: "Distrital de Atalaia do Norte/AM", mSup: 3, mMed: 1, rSup: 1, rMed: 1 },
            { id: "Distrital de Cacoal/RO", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de Cruzeiro do Sul/AC", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de Lábrea/AM", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de Parintins/AM", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de Porto Velho/RO", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de Rio Branco/AC", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de Tabatinga/AM", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de Tefé/AM", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de Manaus/AM", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Regional de Manaus/AM", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de São Luiz/MA", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de Salvador/BA", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Regional de Salvador/BA", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Regional de São Paulo/SP", mSup: 3, mMed: 1, rSup: 3, rMed: 0 },
            { id: "Distrital de Altamira/PA", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de Macapá/AP", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de Itaituba/PA", mSup: 3, mMed: 1, rSup: 3, rMed: 0 },
            { id: "Distrital de Palmas/TO", mSup: 2, mMed: 1, rSup: 2, rMed: 1 },
            { id: "Distrital de Redenção/PA", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de Belém/PA", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Regional do Pará/PA", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de Fortaleza/CE", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de João Pessoa/PB", mSup: 3, mMed: 1, rSup: 3, rMed: 0 },
            { id: "Distrital de Maceió/AL", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Distrital de Recife/PE", mSup: 3, mMed: 1, rSup: 3, rMed: 1 },
            { id: "Regional do Recife/PE", mSup: 3, mMed: 1, rSup: 3, rMed: 1 }
        ];

        // --- DADOS INFRAESTRUTURA ---
        const unitsData = [
            { id: "Distrital de Altamira/PA", city: "Altamira", coords: [-3.203, -52.206], nat: "Locado - CNPJ", mob: "Ausente", lim: "Ausente", jar: "Ausente", int: "Contratação", tel: "Funcionamento", vig: "Ausente", imp: "Ausente", sit: "Não ocupado" },
            { id: "Distrital de Atalaia do Norte/AM", city: "Atalaia do Norte", coords: [-4.371, -70.191], nat: "Locado - CPF", mob: "Regularizado", lim: "Ausente", jar: "Ausente", int: "Contratação", tel: "Funcionamento", vig: "Ausente", imp: "Ausente", sit: "Inadequada" },
            { id: "Distrital de Barra do Garças/MT", city: "Barra do Garças", coords: [-15.893, -52.256], nat: "Locado - CPF", mob: "Regularizado", lim: "Ausente", jar: "N/A", int: "Contratação", tel: "Funcionamento", vig: "Ausente", imp: "Ausente", sit: "Inadequada" },
            { id: "Distrital de Belém/PA", city: "Belém", coords: [-1.455, -48.490], nat: "Coworking", mob: "Regularizado", lim: "Funcionando", jar: "Funcionando", int: "Funcionando", tel: "Funcionamento", vig: "Contratação", imp: "Ausente", sit: "Inadequada" },
            { id: "Distrital de Cacoal/RO", city: "Cacoal", coords: [-11.438, -61.442], nat: "Locado - CNPJ", mob: "Ausente", lim: "Ausente", jar: "Ausente", int: "Contratação", tel: "Funcionamento", vig: "Ausente", imp: "Ausente", sit: "Não ocupado" },
            { id: "Distrital de Campo Grande/MS", city: "Campo Grande", coords: [-20.469, -54.620], nat: "Coworking", mob: "Regularizado", lim: "Funcionando", jar: "Funcionando", int: "Funcionando", tel: "Funcionamento", vig: "Funcionando", imp: "Ausente", sit: "Adequada" },
            { id: "Distrital de Colíder/MT", city: "Colíder", coords: [-10.814, -55.454], nat: "Locado - CNPJ", mob: "Regularizado", lim: "Ausente", jar: "Contratação", int: "Contratação", tel: "Funcionamento", vig: "Funcionando", imp: "Ausente", sit: "Inadequada" },
            { id: "Distrital de Canarana/MT", city: "Canarana", coords: [-13.551, -52.270], nat: "Locado - CNPJ", mob: "Ausente", lim: "Ausente", jar: "N/A", int: "Contratação", tel: "Funcionamento", vig: "Ausente", imp: "Ausente", sit: "Inadequada" },
            { id: "Distrital de Cruzeiro do Sul/AC", city: "Cruzeiro do Sul", coords: [-7.619, -72.673], nat: "Locado - CPF", mob: "Ausente", lim: "Ausente", jar: "Ausente", int: "Contratação", tel: "Funcionamento", vig: "Ausente", imp: "Contratação", sit: "Não ocupado" },
            { id: "Distrital de Florianópolis/SC", city: "Florianópolis", coords: [-27.595, -48.548], nat: "Coworking", mob: "Regularizado", lim: "Funcionando", jar: "N/A", int: "Funcionando", tel: "Funcionamento", vig: "Funcionando", imp: "Contratação", sit: "Adequada" },
            { id: "Distrital de Fortaleza/CE", city: "Fortaleza", coords: [-3.731, -38.526], nat: "Edif. Público", mob: "Planejamento", lim: "Contratação", jar: "Contratação", int: "Contratação", tel: "Funcionamento", vig: "Contratação", imp: "Contratação", sit: "Inadequada" },
            { id: "Distrital de Governador Valadares/MG", city: "Governador Valadares", coords: [-18.851, -41.949], nat: "Coworking", mob: "Regularizado", lim: "Funcionando", jar: "N/A", int: "Funcionando", tel: "Funcionamento", vig: "Funcionando", imp: "Funcionando", sit: "Adequada" },
            { id: "Distrital de Itaituba/PA", city: "Itaituba", coords: [-4.276, -55.983], nat: "Locado - CPF", mob: "Ausente", lim: "Ausente", jar: "Ausente", int: "Contratação", tel: "Funcionamento", vig: "Ausente", imp: "Contratação", sit: "Não ocupado" },
            { id: "Distrital de João Pessoa/PB", city: "João Pessoa", coords: [-7.119, -34.845], nat: "Coworking", mob: "Regularizado", lim: "Funcionando", jar: "N/A", int: "Funcionando", tel: "Funcionamento", vig: "Funcionando", imp: "Contratação", sit: "Adequada" },
            { id: "Distrital de Lábrea/AM", city: "Lábrea", coords: [-7.258, -64.797], nat: "Locado - CPF", mob: "Ausente", lim: "Ausente", jar: "Ausente", int: "Contratação", tel: "Funcionamento", vig: "Ausente", imp: "Contratação", sit: "Inadequada" },
            { id: "Distrital de Maceió/AL", city: "Maceió", coords: [-9.665, -35.735], nat: "Coworking", mob: "Regularizado", lim: "Funcionando", jar: "N/A", int: "Funcionando", tel: "Funcionamento", vig: "Funcionando", imp: "Contratação", sit: "Adequada" },
            { id: "Distrital de Macapá/AP", city: "Macapá", coords: [0.034, -51.066], nat: "Coworking", mob: "Regularizado", lim: "Funcionando", jar: "N/A", int: "Funcionando", tel: "Funcionamento", vig: "Funcionando", imp: "Funcionando", sit: "Adequada" },
            { id: "Distrital de Palmas/TO", city: "Palmas", coords: [-10.184, -48.333], nat: "Coworking", mob: "Regularizado", lim: "Funcionando", jar: "N/A", int: "Funcionando", tel: "Funcionamento", vig: "Funcionando", imp: "Funcionando", sit: "Adequada" },
            { id: "Distrital de Parintins/AM", city: "Parintins", coords: [-2.628, -56.735], nat: "Locado - CPF", mob: "Ausente", lim: "Ausente", jar: "N/A", int: "Contratação", tel: "Funcionamento", vig: "Ausente", imp: "Ausente", sit: "Não ocupado" },
            { id: "Distrital de Porto Velho/RO", city: "Porto Velho", coords: [-8.761, -63.903], nat: "Locado - CNPJ", mob: "Regularizado", lim: "Ausente", jar: "N/A", int: "Contratação", tel: "Funcionamento", vig: "Ausente", imp: "Ausente", sit: "Não ocupado" },
            { id: "Distrital de Rio Branco/AC", city: "Rio Branco", coords: [-9.974, -67.807], nat: "Locado - CNPJ", mob: "Ausente", lim: "Ausente", jar: "N/A", int: "Contratação", tel: "Funcionamento", vig: "Ausente", imp: "Contratação", sit: "Não ocupado" },
            { id: "Distrital de Redenção/PA", city: "Redenção", coords: [-8.026, -50.032], nat: "Locado - CNPJ", mob: "Regularizado", lim: "Ausente", jar: "N/A", int: "Contratação", tel: "Funcionamento", vig: "Ausente", imp: "Ausente", sit: "Inadequada" },
            { id: "Distrital de Sâo Félix do Araguaia/MT", city: "São Félix do Araguaia", coords: [-11.616, -50.669], nat: "Coworking", mob: "NÃO SE APLICA", lim: "Funcionando", jar: "N/A", int: "Funcionando", tel: "Funcionamento", vig: "Ausente", imp: "Funcionando", sit: "Adequada" },
            { id: "Distrital de São Gabriel da Cachoeira/AM", city: "São Gabriel da Cachoeira", coords: [-0.130, -67.089], nat: "Locado - CPF", mob: "Ausente", lim: "Ausente", jar: "N/A", int: "Contratação", tel: "Funcionamento", vig: "Ausente", imp: "Funcionando", sit: "Inadequada" },
            { id: "Distrital de Tabatinga/AM", city: "Tabatinga", coords: [-4.232, -69.938], nat: "Locado - CNPJ", mob: "Regularizado", lim: "Ausente", jar: "N/A", int: "Funcionando", tel: "Funcionamento", vig: "Ausente", imp: "Contratação", sit: "Inadequada" },
            { id: "Distrital de Tefé/AM", city: "Tefé", coords: [-3.354, -64.711], nat: "Locado - CNPJ", mob: "Regularizado", lim: "Contratação", jar: "Contratação", int: "Funcionando", tel: "Funcionamento", vig: "Contratação", imp: "Contratação", sit: "Inadequada" },
            { id: "Reg. Amazonas e Manaus", city: "Manaus", coords: [-3.119, -60.021], nat: "Edif. Público", mob: "NÃO SE APLICA", lim: "N/A", jar: "N/A", int: "N/A", tel: "N/A", vig: "N/A", imp: "N/A", sit: "Contratação" },
            { id: "Reg. Bahia e Salvador", city: "Salvador", coords: [-12.971, -38.501], nat: "Coworking", mob: "Regularizado", lim: "Funcionando", jar: "Funcionando", int: "Funcionando", tel: "Funcionamento", vig: "Funcionando", imp: "Funcionando", sit: "Adequada" },
            { id: "Reg. Centro-Oeste e Cuiabá", city: "Cuiabá", coords: [-15.601, -56.097], nat: "Coworking", mob: "Regularizado", lim: "Funcionando", jar: "N/A", int: "Funcionando", tel: "Funcionamento", vig: "Funcionando", imp: "Ausente", sit: "Adequada" },
            { id: "Reg. Pernambuco e Recife", city: "Recife", coords: [-8.057, -34.882], nat: "Coworking", mob: "Regularizado", lim: "Funcionando", jar: "N/A", int: "Funcionando", tel: "Funcionamento", vig: "Funcionando", imp: "Ausente", sit: "Inadequada" },
            { id: "Reg. Paraná e Curitiba", city: "Curitiba", coords: [-25.429, -49.267], nat: "Coworking", mob: "Regularizado", lim: "Funcionando", jar: "N/A", int: "Funcionando", tel: "Funcionamento", vig: "Funcionando", imp: "Ausente", sit: "Adequada" },
            { id: "Reg. Roraima / Yanomami", city: "Boa Vista", coords: [2.823, -60.675], nat: "Locado - CNPJ", mob: "Regularizado", lim: "Contratação", jar: "N/A", int: "Contratação", tel: "Funcionamento", vig: "Funcionando", imp: "Contratação", sit: "Inadequada" },
            { id: "Regional de São Paulo", city: "São Paulo", coords: [-23.550, -46.633], nat: "Edif. Público", mob: "NÃO SE APLICA", lim: "N/A", jar: "N/A", int: "Funcionando", tel: "Funcionamento", vig: "N/A", imp: "N/A", sit: "Não ocupado" },
            { id: "Distrital de São Luís/MA", city: "São Luís", coords: [-2.530, -44.306], nat: "Coworking", mob: "Regularizado", lim: "Funcionando", jar: "N/A", int: "Funcionando", tel: "Funcionamento", vig: "Funcionando", imp: "Funcionando", sit: "Adequada" }
        ];

        // --- LÓGICA DE RH ---
        function handleSortRh(key) {
            if (rhSort.key === key) rhSort.dir = rhSort.dir === 'asc' ? 'desc' : 'asc';
            else { rhSort.key = key; rhSort.dir = 'asc'; }
            updateSortIconsRh();
            renderRhTable();
        }

        function updateSortIconsRh() {
            document.querySelectorAll('#rhTable .sort-icon').forEach(icon => {
                icon.textContent = '↕';
                icon.parentElement.classList.remove('active-sort');
            });
            const activeHeader = document.getElementById(`icon-rh-${rhSort.key}`);
            if (activeHeader) {
                activeHeader.textContent = rhSort.dir === 'asc' ? '↑' : '↓';
                activeHeader.parentElement.classList.add('active-sort');
            }
        }

        function renderRhTable() {
            const tbody = document.querySelector('#rhTable tbody');
            const searchTerm = document.getElementById('searchInputRh').value.toLowerCase();
            tbody.innerHTML = '';
            
            let filteredRh = rhData.filter(item => item.id.toLowerCase().includes(searchTerm));

            const sortedRh = [...filteredRh].sort((a, b) => {
                let vA, vB;
                if (rhSort.key === 'totalMeta') {
                    vA = a.mSup + a.mMed; vB = b.mSup + b.mMed;
                } else if (rhSort.key === 'totalReal') {
                    vA = a.rSup + a.rMed; vB = b.rSup + b.rMed;
                } else if (rhSort.key === 'isFull') {
                    vA = (a.rSup + a.rMed) >= (a.mSup + a.mMed);
                    vB = (b.rSup + b.rMed) >= (b.mSup + b.mMed);
                } else {
                    vA = a[rhSort.key]; vB = b[rhSort.key];
                }
                if (typeof vA === 'string') { vA = vA.toLowerCase(); vB = vB.toLowerCase(); }
                return rhSort.dir === 'asc' ? (vA > vB ? 1 : -1) : (vA < vB ? 1 : -1);
            });

            sortedRh.forEach(item => {
                const totalMeta = item.mSup + item.mMed;
                const totalReal = item.rSup + item.rMed;
                const isFull = totalReal >= totalMeta;

                const row = `
                    <tr class="hover:bg-slate-50 transition-colors border-b border-slate-100">
                        <td class="px-4 py-3.5 font-bold text-slate-700 sticky left-0 bg-white z-10 border-r">${item.id}</td>
                        <td class="px-3 py-3.5 text-center text-slate-400 font-medium">${item.mSup}</td>
                        <td class="px-3 py-3.5 text-center font-bold text-slate-800">${item.rSup}</td>
                        <td class="px-3 py-3.5 text-center text-slate-400 font-medium">${item.mMed}</td>
                        <td class="px-3 py-3.5 text-center font-bold text-slate-800">${item.rMed}</td>
                        <td class="px-3 py-3.5 text-center bg-slate-50 font-bold">${totalMeta}</td>
                        <td class="px-3 py-3.5 text-center bg-blue-50 font-bold text-blue-700">${totalReal}</td>
                        <td class="px-4 py-3.5 text-center">
                            <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase ${isFull ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                                ${isFull ? 'Sim' : 'Não'}
                            </span>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            let tMeta = rhData.reduce((acc, curr) => acc + curr.mSup + curr.mMed, 0);
            let tReal = rhData.reduce((acc, curr) => acc + curr.rSup + curr.rMed, 0);
            document.getElementById('totalMeta').textContent = tMeta;
            document.getElementById('totalReal').textContent = tReal;
            document.getElementById('totalFillPercent').textContent = Math.round((tReal / tMeta) * 100) + '%';
        }

        function initRhCharts() {
            if (rhChartInstance) rhChartInstance.destroy();
            const ctx = document.getElementById('staffingSummaryChart').getContext('2d');
            const labels = rhData.map(d => d.id.replace('Distrital de ', '').replace('Regional de ', ''));
            const dataMeta = rhData.map(d => d.mSup + d.mMed);
            const dataReal = rhData.map(d => d.rSup + d.rMed);

            rhChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Meta de Vagas', data: dataMeta, backgroundColor: '#e2e8f0', borderRadius: 4 },
                        { label: 'Vagas Preenchidas', data: dataReal, backgroundColor: '#3b82f6', borderRadius: 4 }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false }, ticks: { font: { size: 9 } } }
                    },
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } }
                }
            });
        }

        // --- LÓGICA DE INFRAESTRUTURA ---
        function calculateCompliance(u) {
            const fields = ['mob', 'lim', 'jar', 'int', 'tel', 'vig', 'imp'];
            let successes = 0, applicable = 0;
            fields.forEach(f => {
                const val = (u[f] || "").toLowerCase();
                if (val !== 'n/a' && !val.includes('não se aplica')) {
                    applicable++;
                    if (val === 'sim' || val === 'funcionando' || val === 'regularizado' || val === 'funcionamento') successes++;
                }
            });
            return applicable > 0 ? Math.round((successes / applicable) * 100) : 0;
        }

        function getComplianceColor(percent) {
            if (percent >= 90) return '#16a34a';
            if (percent >= 80) return '#22c55e';
            if (percent >= 70) return '#84cc16';
            if (percent >= 60) return '#eab308';
            if (percent >= 50) return '#f97316';
            if (percent >= 40) return '#ef4444';
            if (percent >= 30) return '#dc2626';
            if (percent >= 20) return '#b91c1c';
            if (percent >= 10) return '#991b1b';
            return '#7f1d1d';
        }

        function getTextColor(percent) {
            if (percent >= 70) return '#ffffff';
            if (percent >= 40) return '#1e293b';
            return '#ffffff';
        }

        function handleSort(key) {
            if (currentSort.key === key) currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
            else { currentSort.key = key; currentSort.dir = 'asc'; }
            updateSortIcons();
            applyFilters();
        }

        function updateSortIcons() {
            document.querySelectorAll('#infraTable .sort-icon').forEach(icon => {
                icon.textContent = '↕';
                icon.parentElement.classList.remove('active-sort');
            });
            const activeHeader = document.getElementById(`icon-${currentSort.key}`);
            if (activeHeader) {
                activeHeader.textContent = currentSort.dir === 'asc' ? '↑' : '↓';
                activeHeader.parentElement.classList.add('active-sort');
            }
        }

        function renderTable(data) {
            const tbody = document.querySelector('#infraTable tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            
            const sorted = [...data].sort((a, b) => {
                let vA = a[currentSort.key], vB = b[currentSort.key];
                if (currentSort.key === 'compliance') { vA = calculateCompliance(a); vB = calculateCompliance(b); }
                if (typeof vA === 'string') { vA = vA.toLowerCase(); vB = vB.toLowerCase(); }
                return currentSort.dir === 'asc' ? (vA > vB ? 1 : -1) : (vA < vB ? 1 : -1);
            });

            sorted.forEach(item => {
                const compliance = calculateCompliance(item);
                const backgroundColor = getComplianceColor(compliance);
                const textColor = getTextColor(compliance);
                
                const row = `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-4 py-3.5 font-bold text-slate-800 sticky left-0 bg-white z-10 border-r border-b">${item.id}</td>
                        <td class="px-3 py-3.5 border-b text-center">
                            <div class="percent-badge" style="background-color: ${backgroundColor}; border-color: ${backgroundColor}; color: ${textColor}">
                                ${compliance}%
                            </div>
                        </td>
                        <td class="px-3 py-3.5 text-slate-500 border-b">${item.nat}</td>
                        <td class="px-3 py-3.5 border-b"><span class="status-badge ${getStatusClass(item.mob)}">${item.mob}</span></td>
                        <td class="px-3 py-3.5 border-b"><span class="status-badge ${getStatusClass(item.lim)}">${item.lim}</span></td>
                        <td class="px-3 py-3.5 border-b"><span class="status-badge ${getStatusClass(item.jar)}">${item.jar}</span></td>
                        <td class="px-3 py-3.5 border-b"><span class="status-badge ${getStatusClass(item.int)}">${item.int}</span></td>
                        <td class="px-3 py-3.5 border-b"><span class="status-badge ${getStatusClass(item.tel)}">${item.tel}</span></td>
                        <td class="px-3 py-3.5 border-b"><span class="status-badge ${getStatusClass(item.vig)}">${item.vig}</span></td>
                        <td class="px-3 py-3.5 border-b"><span class="status-badge ${getStatusClass(item.imp)}">${item.imp}</span></td>
                        <td class="px-4 py-3.5 text-center border-b"><span class="status-badge ${getSituationClass(item.sit)} uppercase">${item.sit}</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function getStatusClass(text) {
            const t = (text || "").toLowerCase();
            if (t.includes('funciona') || t.includes('adequada') || t === 'regularizado' || t === 'sim') return 'bg-ok';
            if (t.includes('contratação') || t.includes('inadequada') || t === 'planejamento') return 'bg-warning';
            return 'bg-error';
        }

        function getSituationClass(text) {
            const t = (text || "").toLowerCase();
            if (t.includes('adequada')) return 'sit-adequada';
            if (t.includes('inadequada')) return 'sit-inadequada';
            if (t.includes('não ocupado')) return 'sit-nao-ocupado';
            return 'sit-contratacao';
        }

        function initMunicipioFilter() {
            const municipioFilter = document.getElementById('municipioFilter');
            if (!municipioFilter) return;
            const municipios = [...new Set(unitsData.map(item => item.city))].sort();
            while (municipioFilter.options.length > 1) municipioFilter.remove(1);
            municipios.forEach(municipio => {
                const option = document.createElement('option');
                option.value = municipio; option.textContent = municipio;
                municipioFilter.appendChild(option);
            });
        }

        function initMap() {
            // AJUSTE: Limitando Zoom e Área do Mapa
            map = L.map('map', { 
                minZoom: 4, 
                maxBounds: [[-35, -75], [5, -30]], // Restringe a área de navegação (aprox. Brasil)
                maxBoundsViscosity: 1.0 
            }).setView([-15.78, -52], 4);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            renderMarkers(unitsData);
        }

        function renderMarkers(data) {
            markersLayer.clearLayers();
            data.forEach(u => {
                if (!u.coords) return;
                const color = u.sit.includes('Adequada') ? '#16a34a' : u.sit.includes('Inadequada') ? '#fb923c' : (u.sit.includes('Ocupado') ? '#dc2626' : '#3b82f6');
                const marker = L.circleMarker(u.coords, { radius: 7, fillColor: color, color: "#fff", weight: 1.5, fillOpacity: 0.9 });
                
                // Melhoria no Tooltip do Vanilla JS para corresponder ao pedido
                marker.bindTooltip(u.city, { 
                    permanent: true, 
                    direction: 'top', 
                    className: 'city-label', 
                    offset: [0, -8],
                    opacity: 0.9
                });
                
                markersLayer.addLayer(marker);
            });
        }

        function initCharts() {
            try { Chart.register(ChartDataLabels); } catch(e) {}
            const situations = { "Adequada": 0, "Inadequada": 0, "Não ocupado": 0, "Contratação": 0 };
            const naturezas = { "Coworking": 0, "Locado - CNPJ": 0, "Locado - CPF": 0, "Edif. Público": 0 };
            const mobStatus = { "Regularizado": 0, "Ausente": 0, "Planejamento": 0, "N/A": 0 };
            
            const fields = ['mob', 'lim', 'jar', 'int', 'tel', 'vig', 'imp'];
            const labels = ['Mob.', 'Limpeza', 'Jardim', 'Internet', 'Tel.', 'Vigil.', 'Impres.'];
            const stats = { mob: { ok: 0, app: 0 }, lim: { ok: 0, app: 0 }, jar: { ok: 0, app: 0 }, int: { ok: 0, app: 0 }, tel: { ok: 0, app: 0 }, vig: { ok: 0, app: 0 }, imp: { ok: 0, app: 0 } };

            unitsData.forEach(u => {
                if (u.sit.includes("Adequada")) situations["Adequada"]++;
                else if (u.sit.includes("Inadequada")) situations["Inadequada"]++;
                else if (u.sit.includes("Não ocupado")) situations["Não ocupado"]++;
                else situations["Contratação"]++;
                if (naturezas[u.nat] !== undefined) naturezas[u.nat]++;
                if (mobStatus[u.mob] !== undefined) mobStatus[u.mob]++; else mobStatus["N/A"]++;

                fields.forEach(f => {
                    const val = (u[f] || "").toLowerCase();
                    if (val !== 'n/a' && !val.includes('não se aplica')) {
                        stats[f].app++;
                        if (val === 'sim' || val === 'funcionando' || val === 'regularizado' || val === 'funcionamento') stats[f].ok++;
                    }
                });
            });

            const servicesData = fields.map(f => stats[f].app > 0 ? Math.round((stats[f].ok / stats[f].app) * 100) : 0);
            const cfg = { maintainAspectRatio: false, plugins: { datalabels: { color: '#fff', font: { weight: 'bold', size: 9 } }, legend: { position: 'bottom', labels: { boxWidth: 8, font: { size: 9 } } } } };
            
            new Chart(document.getElementById('situationChart'), { type: 'doughnut', data: { labels: Object.keys(situations), datasets: [{ data: Object.values(situations), backgroundColor: ['#16a34a', '#fb923c', '#dc2626', '#3b82f6'] }] }, options: cfg });
            new Chart(document.getElementById('natureChart'), { type: 'pie', data: { labels: Object.keys(naturezas), datasets: [{ data: Object.values(naturezas), backgroundColor: ['#6366f1', '#a855f7', '#ec4899', '#64748b'] }] }, options: cfg });
            new Chart(document.getElementById('mobDetailedChart'), { type: 'doughnut', data: { labels: Object.keys(mobStatus), datasets: [{ data: Object.values(mobStatus), backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#94a3b8'] }] }, options: cfg });
            
            // Gráfico de Barras em Evidência (Ajuste para Horizontal e Rótulos Visíveis)
            new Chart(document.getElementById('servicesChart'), { 
                type: 'bar', 
                data: { labels: labels, datasets: [{ label: '% de Sucesso', data: servicesData, backgroundColor: '#3b82f6', borderRadius: 6 }] }, 
                options: { 
                    maintainAspectRatio: false,
                    indexAxis: 'x', // Voltar para vertical para ocupar melhor a largura total
                    scales: {
                        y: { beginAtZero: true, max: 115, grid: { borderDash: [2, 4] } }, // Max 115 para dar espaço ao rótulo
                        x: { grid: { display: false } }
                    },
                    plugins: { 
                        legend: { display: false }, 
                        // AJUSTE: Rótulos escuros no topo da barra
                        datalabels: { 
                            color: '#334155', 
                            anchor: 'end', 
                            align: 'top', 
                            offset: -4,
                            font: { weight: 'bold', size: 11 },
                            formatter: (v) => v + '%' 
                        } 
                    } 
                } 
            });
        }

        function applyFilters() {
            const municipioValue = document.getElementById('municipioFilter').value;
            const natureValue = document.getElementById('natureFilter').value;
            const situacaoValue = document.getElementById('situacaoFilter').value;
            
            const filtered = unitsData.filter(u => {
                const municipioMatch = municipioValue === 'all' || u.city === municipioValue;
                const natureMatch = natureValue === 'all' || u.nat === natureValue;
                const situacaoMatch = situacaoValue === 'all' || u.sit === situacaoValue;
                return municipioMatch && natureMatch && situacaoMatch;
            });
            
            renderTable(filtered);
            renderMarkers(filtered);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initMunicipioFilter();
            renderTable(unitsData);
            initMap();
            setTimeout(initCharts, 300);
            
            // Listeners Infra
            document.getElementById('municipioFilter').addEventListener('change', applyFilters);
            document.getElementById('natureFilter').addEventListener('change', applyFilters);
            document.getElementById('situacaoFilter').addEventListener('change', applyFilters);
            document.getElementById('searchInputRh').addEventListener('input', renderRhTable);
            
            // Garante que a aba de Utilidades (React) renderize corretamente o mapa na carga inicial
            setTimeout(() => window.dispatchEvent(new Event('resize')), 100);

            // Renderiza ícones Lucide
            if(window.lucide) window.lucide.createIcons();
        });
    </script>

    <!-- SCRIPT REACT (LÓGICA DA ABA 3: LOCAÇÕES E UTILIDADES) -->
    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, Legend, LabelList } = window.Recharts;

        // Configuração React App
        const COLORS_STATUS = { "No Prazo": "#10b981", "Em Atraso": "#ef4444", "Pendente": "#f59e0b" };
        
        const cityMetadata = {
            "Rio Branco (AC)": { uf: "AC", lat: -9.974, lng: -67.807 }, "Cruzeiro do Sul (AC)": { uf: "AC", lat: -7.631, lng: -72.670 },
            "Atalaia do Norte": { uf: "AM", lat: -4.372, lng: -70.192 }, "Tabatinga": { uf: "AM", lat: -4.230, lng: -69.938 }, 
            "Tefé": { uf: "AM", lat: -3.352, lng: -64.710 }, "Lábrea (AM)": { uf: "AM", lat: -7.259, lng: -64.798 }, 
            "Parintins (AM)": { uf: "AM", lat: -2.628, lng: -56.735 }, "São Gabriel da Cachoeira (AM)": { uf: "AM", lat: -0.130, lng: -67.089 },
            "Boa Vista (RR)": { uf: "RR", lat: 2.823, lng: -60.675 }, "Boa Vista": { uf: "RR", lat: 2.823, lng: -60.675 }, 
            "Macapá": { uf: "AP", lat: 0.038, lng: -51.066 }, "Altamira (PA)": { uf: "PA", lat: -3.204, lng: -52.206 }, 
            "Redenção": { uf: "PA", lat: -8.027, lng: -50.030 }, "Belém (PA)": { uf: "PA", lat: -1.455, lng: -48.502 }, 
            "Itaituba (PA)": { uf: "PA", lat: -4.276, lng: -55.983 }, "Palmas": { uf: "TO", lat: -10.168, lng: -48.331 },
            "Cacoal": { uf: "RO", lat: -11.433, lng: -61.442 }, "Porto Velho (RO)": { uf: "RO", lat: -8.761, lng: -63.903 },
            "Colíder": { uf: "MT", lat: -10.805, lng: -55.451 }, "Canarana (MT)": { uf: "MT", lat: -13.553, lng: -52.261 }, 
            "Barra do Garças": { uf: "MT", lat: -15.890, lng: -52.256 }, "Cuiabá": { uf: "MT", lat: -15.595, lng: -56.096 }, 
            "São Félix do Araguaia (MT)": { uf: "MT", lat: -11.616, lng: -50.668 }, "Campo Grande": { uf: "MS", lat: -20.442, lng: -54.646 },
            "João Pessoa (PB)": { uf: "PB", lat: -7.115, lng: -34.863 }, "Recife (PE)": { uf: "PE", lat: -8.047, lng: -34.877 }, 
            "Maceió (AL)": { uf: "AL", lat: -9.665, lng: -35.735 }, "Salvador (BA)": { uf: "BA", lat: -12.971, lng: -38.510 }, 
            "São Luiz (MA)": { uf: "MA", lat: -2.529, lng: -44.302 }, "Gov Valadares": { uf: "MG", lat: -18.851, lng: -41.946 }, 
            "Curitiba (PR)": { uf: "PR", lat: -25.428, lng: -49.273 }, "Florianópolis (SC)": { uf: "SC", lat: -27.595, lng: -48.548 }
        };

        const rawData = [
            // Locações (Reduzidos no script para clareza visual, mas completos mantidos)
            { cidade: "Rio Branco (AC)", valor: 4858.00, mes: "Dezembro", emissao: "01/01/2026", vencimento: "19/01/2026", pagamento: "18/01/2026", tipo: "Locação de Imóveis" },
            { cidade: "Altamira (PA)", valor: 6000.00, mes: "Outubro", tipo: "Locação de Imóveis" },
            { cidade: "Altamira (PA)", valor: 6000.00, mes: "Novembro", emissao: "13/11/2025", vencimento: "10/12/2025", pagamento: "03/12/2025", tipo: "Locação de Imóveis" },
            { cidade: "Altamira (PA)", valor: 6000.00, mes: "Dezembro", emissao: "23/12/2025", vencimento: "12/01/2026", tipo: "Locação de Imóveis" },
            { cidade: "Atalaia do Norte", valor: 5000.00, mes: "Abril", emissao: "30/05/2025", vencimento: "06/06/2025", pagamento: "12/06/2025", tipo: "Locação de Imóveis" },
            { cidade: "Atalaia do Norte", valor: 5000.00, mes: "Maio", emissao: "30/05/2025", vencimento: "06/06/2025", pagamento: "12/06/2025", tipo: "Locação de Imóveis" },
            { cidade: "Atalaia do Norte", valor: 5000.00, mes: "Junho", emissao: "30/06/2025", vencimento: "02/07/2025", pagamento: "21/07/2025", tipo: "Locação de Imóveis" },
            { cidade: "Atalaia do Norte", valor: 5000.00, mes: "Julho", emissao: "30/07/2025", vencimento: "08/08/2025", tipo: "Locação de Imóveis" },
            { cidade: "Atalaia do Norte", valor: 5000.00, mes: "Agosto", emissao: "30/08/2025", vencimento: "02/09/2025", pagamento: "29/08/2025", tipo: "Locação de Imóveis" },
            { cidade: "Atalaia do Norte", valor: 5000.00, mes: "Setembro", emissao: "30/09/2025", vencimento: "02/10/2025", pagamento: "02/10/2025", tipo: "Locação de Imóveis" },
            { cidade: "Atalaia do Norte", valor: 5000.00, mes: "Outubro", emissao: "30/10/2025", vencimento: "02/11/2025", pagamento: "02/11/2025", tipo: "Locação de Imóveis" },
            { cidade: "Atalaia do Norte", valor: 5000.00, mes: "Novembro", emissao: "30/11/2025", vencimento: "02/12/2025", pagamento: "03/12/2025", tipo: "Locação de Imóveis" },
            { cidade: "Atalaia do Norte", valor: 5000.00, mes: "Dezembro", emissao: "30/12/2025", vencimento: "02/01/2026", pagamento: "22/12/2025", tipo: "Locação de Imóveis" },
            { cidade: "Barra do Garças", valor: 2500.00, mes: "Junho", emissao: "18/06/2025", vencimento: "10/07/2025", pagamento: "10/07/2025", tipo: "Locação de Imóveis" },
            { cidade: "Barra do Garças", valor: 2500.00, mes: "Julho", emissao: "18/06/2025", vencimento: "10/07/2025", pagamento: "10/07/2025", tipo: "Locação de Imóveis" },
            { cidade: "Barra do Garças", valor: 2500.00, mes: "Agosto", emissao: "21/07/2025", vencimento: "10/08/2025", pagamento: "10/08/2025", tipo: "Locação de Imóveis" },
            { cidade: "Barra do Garças", valor: 2500.00, mes: "Setembro", emissao: "21/08/2025", vencimento: "10/09/2025", pagamento: "10/09/2025", tipo: "Locação de Imóveis" },
            { cidade: "Barra do Garças", valor: 2500.00, mes: "Outubro", emissao: "18/09/2025", vencimento: "10/10/2025", pagamento: "10/10/2025", tipo: "Locação de Imóveis" },
            { cidade: "Barra do Garças", valor: 2500.00, mes: "Novembro", emissao: "18/10/2025", vencimento: "10/11/2025", pagamento: "10/11/2025", tipo: "Locação de Imóveis" },
            { cidade: "Barra do Garças", valor: 2500.00, mes: "Dezembro", emissao: "04/12/2025", vencimento: "10/12/2025", pagamento: "12/12/2025", tipo: "Locação de Imóveis" },
            { cidade: "Boa Vista (RR)", valor: 23800.00, mes: "Dezembro", emissao: "02/12/2025", vencimento: "15/12/2025", pagamento: "15/12/2025", tipo: "Locação de Imóveis" },
            { cidade: "Campo Grande", valor: 8000.00, mes: "Maio", emissao: "02/06/2025", vencimento: "17/06/2025", pagamento: "18/06/2025", tipo: "Locação de Imóveis" },
            { cidade: "Campo Grande", valor: 8000.00, mes: "Junho", emissao: "01/07/2025", vencimento: "15/07/2025", pagamento: "16/07/2025", tipo: "Locação de Imóveis" },
            { cidade: "Campo Grande", valor: 8000.00, mes: "Julho", emissao: "01/08/2025", vencimento: "15/08/2025", pagamento: "15/08/2025", tipo: "Locação de Imóveis" },
            { cidade: "Campo Grande", valor: 8000.00, mes: "Agosto", emissao: "01/09/2025", vencimento: "15/09/2025", pagamento: "15/09/2025", tipo: "Locação de Imóveis" },
            { cidade: "Campo Grande", valor: 8000.00, mes: "Setembro", emissao: "01/10/2025", vencimento: "15/10/2025", pagamento: "15/10/2025", tipo: "Locação de Imóveis" },
            { cidade: "Campo Grande", valor: 8000.00, mes: "Novembro", emissao: "03/11/2025", vencimento: "15/11/2025", pagamento: "17/11/2025", tipo: "Locação de Imóveis" },
            { cidade: "Campo Grande", valor: 8000.00, mes: "Dezembro", emissao: "01/12/2025", vencimento: "15/12/2025", pagamento: "18/12/2025", tipo: "Locação de Imóveis" },
            { cidade: "Canarana (MT)", valor: 5000.00, mes: "Outubro", emissao: "05/11/2025", vencimento: "18/11/2025", pagamento: "26/11/2025", tipo: "Locação de Imóveis" },
            { cidade: "Canarana (MT)", valor: 5000.00, mes: "Novembro", emissao: "01/12/2025", vencimento: "18/12/2025", pagamento: "16/12/2025", tipo: "Locação de Imóveis" },
            { cidade: "Colíder", valor: 3900.00, mes: "Junho", emissao: "06/06/2025", vencimento: "23/06/2025", pagamento: "03/07/2025", tipo: "Locação de Imóveis" },
            { cidade: "Colíder", valor: 3900.00, mes: "Julho", emissao: "26/06/2025", vencimento: "22/07/2025", pagamento: "22/07/2025", tipo: "Locação de Imóveis" },
            { cidade: "Colíder", valor: 3900.00, mes: "Agosto", emissao: "26/06/2025", vencimento: "22/08/2025", pagamento: "22/08/2025", tipo: "Locação de Imóveis" },
            { cidade: "Colíder", valor: 3900.00, mes: "Setembro", emissao: "26/06/2025", vencimento: "22/09/2025", pagamento: "19/09/2025", tipo: "Locação de Imóveis" },
            { cidade: "Colíder", valor: 3900.00, mes: "Outubro", emissao: "26/06/2025", vencimento: "22/10/2025", pagamento: "20/10/2025", tipo: "Locação de Imóveis" },
            { cidade: "Colíder", valor: 3900.00, mes: "Novembro", emissao: "26/06/2025", vencimento: "24/11/2025", pagamento: "24/11/2025", tipo: "Locação de Imóveis" },
            { cidade: "Colíder", valor: 3900.00, mes: "Dezembro", emissao: "26/06/2025", vencimento: "22/12/2025", pagamento: "19/12/2025", tipo: "Locação de Imóveis" },
            { cidade: "Cruzeiro do Sul (AC)", valor: 3700.00, mes: "Novembro", emissao: "17/11/2025", vencimento: "25/11/2025", pagamento: "24/11/2025", tipo: "Locação de Imóveis" },
            { cidade: "Cruzeiro do Sul (AC)", valor: 3700.00, mes: "Dezembro", emissao: "04/12/2025", vencimento: "10/12/2025", pagamento: "10/12/2025", tipo: "Locação de Imóveis" },
            { cidade: "Cuiabá", valor: 5800.00, mes: "Junho", emissao: "18/06/2025", vencimento: "28/06/2025", pagamento: "11/07/2025", tipo: "Locação de Imóveis" },
            { cidade: "Cuiabá", valor: 5800.00, mes: "Julho", emissao: "10/07/2025", vencimento: "20/07/2025", pagamento: "22/07/2025", tipo: "Locação de Imóveis" },
            { cidade: "Cuiabá", valor: 5800.00, mes: "Agosto", emissao: "13/08/2025", vencimento: "23/08/2025", pagamento: "27/08/2025", tipo: "Locação de Imóveis" },
            { cidade: "Cuiabá", valor: 5800.00, mes: "Setembro", emissao: "10/09/2025", vencimento: "20/09/2025", pagamento: "26/09/2025", tipo: "Locação de Imóveis" },
            { cidade: "Cuiabá", valor: 5800.00, mes: "Outubro", emissao: "15/10/2025", vencimento: "26/10/2025", pagamento: "27/10/2025", tipo: "Locação de Imóveis" },
            { cidade: "Cuiabá", valor: 5800.00, mes: "Novembro", emissao: "10/11/2025", vencimento: "21/11/2025", pagamento: "11/12/2025", tipo: "Locação de Imóveis" },
            { cidade: "Cuiabá", valor: 5800.00, mes: "Dezembro", emissao: "11/12/2025", vencimento: "30/01/2026", pagamento: "16/01/2026", tipo: "Locação de Imóveis" },
            { cidade: "Curitiba (PR)", valor: 9600.00, mes: "Novembro", emissao: "01/12/2025", vencimento: "15/12/2025", pagamento: "15/12/2025", tipo: "Locação de Imóveis" },
            { cidade: "Curitiba (PR)", valor: 9600.00, mes: "Dezembro", emissao: "01/12/2025", vencimento: "19/01/2026", pagamento: "19/01/2026", tipo: "Locação de Imóveis" },
            { cidade: "Florianópolis (SC)", valor: 12100.00, mes: "Outubro", emissao: "31/10/2025", vencimento: "10/11/2025", pagamento: "10/11/2025", tipo: "Locação de Imóveis" },
            { cidade: "Florianópolis (SC)", valor: 12100.00, mes: "Novembro", emissao: "02/12/2025", vencimento: "19/12/2025", pagamento: "17/12/2025", tipo: "Locação de Imóveis" },
            { cidade: "Gov Valadares", valor: 8000.00, mes: "Outubro", emissao: "24/09/2025", vencimento: "22/10/2025", pagamento: "18/11/2025", tipo: "Locação de Imóveis" },
            { cidade: "João Pessoa (PB)", valor: 6000.00, mes: "Novembro", emissao: "04/11/2025", vencimento: "15/11/2025", pagamento: "17/11/2025", tipo: "Locação de Imóveis" },
            { cidade: "Maceió (AL)", valor: 6000.00, mes: "Outubro", emissao: "28/10/2025", vencimento: "15/11/2025", pagamento: "17/11/2025", tipo: "Locação de Imóveis" },
            { cidade: "Palmas", valor: 7600.00, mes: "Outubro", emissao: "22/10/2025", vencimento: "28/10/2025", pagamento: "28/10/2025", tipo: "Locação de Imóveis" },
            { cidade: "Palmas", valor: 7600.00, mes: "Novembro", emissao: "22/10/2025", vencimento: "28/11/2025", pagamento: "28/11/2025", tipo: "Locação de Imóveis" },
            { cidade: "Palmas", valor: 7600.00, mes: "Dezembro", emissao: "22/10/2025", vencimento: "28/12/2025", pagamento: "23/12/2025", tipo: "Locação de Imóveis" },
            { cidade: "Recife (PE)", valor: 17000.00, mes: "Janeiro", emissao: "06/01/2026", vencimento: "16/01/2026", pagamento: "16/01/2026", tipo: "Locação de Imóveis" },
            { cidade: "Redenção", valor: 6000.00, mes: "Outubro", emissao: "16/06/2025", vencimento: "10/11/2025", pagamento: "21/11/2025", tipo: "Locação de Imóveis" },
            { cidade: "Salvador (BA)", valor: 11000.00, mes: "Novembro", emissao: "02/12/2025", vencimento: "10/12/2025", pagamento: "15/12/2025", tipo: "Locação de Imóveis" },
            { cidade: "Tabatinga", valor: 7500.00, mes: "Dezembro", emissao: "01/12/2025", vencimento: "26/12/2025", pagamento: "19/12/2025", tipo: "Locação de Imóveis" },
            { cidade: "Cacoal", valor: 4554.00, mes: "Janeiro", emissao: "05/01/2026", vencimento: "15/01/2026", pagamento: "15/01/2026", tipo: "Locação de Imóveis" },
            { cidade: "Macapá", valor: 11300.00, mes: "Janeiro", emissao: "09/01/2026", vencimento: "19/01/2026", pagamento: "21/01/2026", tipo: "Locação de Imóveis" },

            // Energia
            { cidade: "Atalaia do Norte", valor: 445.37, mes: "Junho", emissao: "09/06/2025", vencimento: "08/07/2025", pagamento: "09/07/2025", tipo: "Energia Elétrica" },
            { cidade: "Atalaia do Norte", valor: 472.63, mes: "Julho", emissao: "11/07/2025", vencimento: "07/08/2025", pagamento: "07/08/2025", tipo: "Energia Elétrica" },
            { cidade: "Atalaia do Norte", valor: 402.98, mes: "Agosto", emissao: "08/08/2025", vencimento: "04/09/2025", pagamento: "04/09/2025", tipo: "Energia Elétrica" },
            { cidade: "Atalaia do Norte", valor: 507.02, mes: "Setembro", emissao: "04/09/2025", vencimento: "06/10/2025", pagamento: "06/10/2025", tipo: "Energia Elétrica" },
            { cidade: "Atalaia do Norte", valor: 612.30, mes: "Outubro", emissao: "09/10/2025", vencimento: "06/11/2025", pagamento: "06/11/2025", tipo: "Energia Elétrica" },
            { cidade: "Atalaia do Norte", valor: 726.11, mes: "Novembro", emissao: "07/11/2025", vencimento: "04/12/2025", pagamento: "04/12/2025", tipo: "Energia Elétrica" },
            { cidade: "Atalaia do Norte", valor: 936.58, mes: "Dezembro", emissao: "09/12/2025", vencimento: "05/01/2026", tipo: "Energia Elétrica" },
            { cidade: "Barra do Garças", valor: 19.66, mes: "Julho", emissao: "22/07/2025", vencimento: "11/08/2025", pagamento: "11/08/2025", tipo: "Energia Elétrica" },
            { cidade: "Barra do Garças", valor: 58.24, mes: "Agosto", emissao: "22/08/2025", vencimento: "11/09/2025", pagamento: "12/09/2025", tipo: "Energia Elétrica" },
            { cidade: "Barra do Garças", valor: 266.36, mes: "Setembro", emissao: "22/09/2025", vencimento: "11/10/2025", pagamento: "09/10/2025", tipo: "Energia Elétrica" },
            { cidade: "Barra do Garças", valor: 834.71, mes: "Outubro", emissao: "22/10/2025", vencimento: "11/11/2025", pagamento: "11/11/2025", tipo: "Energia Elétrica" },
            { cidade: "Barra do Garças", valor: 660.31, mes: "Novembro", emissao: "24/11/2025", vencimento: "11/12/2025", pagamento: "16/12/2025", tipo: "Energia Elétrica" },
            { cidade: "Canarana (MT)", valor: 125.08, mes: "Janeiro", emissao: "30/12/2025", vencimento: "21/01/2026", pagamento: "21/01/2026", tipo: "Energia Elétrica" },
            { cidade: "Colíder", valor: 117.42, mes: "Julho", emissao: "08/07/2025", vencimento: "22/08/2025", pagamento: "22/08/2025", tipo: "Energia Elétrica" },
            { cidade: "Colíder", valor: 150.14, mes: "Agosto", emissao: "08/08/2025", vencimento: "15/08/2025", pagamento: "15/08/2025", tipo: "Energia Elétrica" },
            { cidade: "Colíder", valor: 199.32, mes: "Setembro", emissao: "08/09/2025", vencimento: "15/09/2025", pagamento: "12/09/2025", tipo: "Energia Elétrica" },
            { cidade: "Colíder", valor: 192.60, mes: "Outubro", emissao: "10/10/2025", vencimento: "15/10/2025", pagamento: "14/10/2025", tipo: "Energia Elétrica" },
            { cidade: "Colíder", valor: 363.40, mes: "Novembro", emissao: "07/11/2025", vencimento: "14/11/2025", pagamento: "17/11/2025", tipo: "Energia Elétrica" },
            { cidade: "Colíder", valor: 537.72, mes: "Dezembro", emissao: "08/12/2025", vencimento: "15/12/2025", pagamento: "15/12/2025", tipo: "Energia Elétrica" },
            { cidade: "Cruzeiro do Sul (AC)", valor: 337.69, mes: "Novembro", emissao: "10/11/2025", vencimento: "01/12/2025", pagamento: "03/12/2025", tipo: "Energia Elétrica" },
            { cidade: "Cruzeiro do Sul (AC)", valor: 414.09, mes: "Dezembro", emissao: "11/12/2025", vencimento: "01/01/2026", pagamento: "14/01/2026", tipo: "Energia Elétrica" },
            { cidade: "Lábrea (AM)", valor: 84.30, mes: "Janeiro", emissao: "07/01/2026", vencimento: "05/02/2026", tipo: "Energia Elétrica" },
            { cidade: "Parintins (AM)", valor: 116.84, mes: "Outubro", emissao: "23/10/2025", vencimento: "15/11/2025", pagamento: "22/12/2025", tipo: "Energia Elétrica" },
            { cidade: "Parintins (AM)", valor: 169.02, mes: "Novembro", emissao: "21/11/2025", vencimento: "15/12/2025", pagamento: "22/12/2025", tipo: "Energia Elétrica" },
            { cidade: "Parintins (AM)", valor: 129.87, mes: "Dezembro", emissao: "26/12/2025", vencimento: "15/01/2026", pagamento: "16/01/2026", tipo: "Energia Elétrica" },
            { cidade: "Redenção", valor: 85.28, mes: "Agosto", emissao: "05/08/2025", vencimento: "12/08/2025", pagamento: "11/09/2025", tipo: "Energia Elétrica" },
            { cidade: "Redenção", valor: 93.10, mes: "Setembro", emissao: "02/09/2025", vencimento: "09/09/2025", pagamento: "11/09/2025", tipo: "Energia Elétrica" },
            { cidade: "Redenção", valor: 99.33, mes: "Outubro", emissao: "18/11/2025", vencimento: "10/10/2025", pagamento: "10/12/2025", tipo: "Energia Elétrica" },
            { cidade: "Redenção", valor: 221.29, mes: "Novembro", emissao: "18/11/2025", vencimento: "12/11/2025", pagamento: "10/12/2025", tipo: "Energia Elétrica" },
            { cidade: "São Gabriel da Cachoeira (AM)", valor: 96.92, mes: "Novembro", emissao: "14/11/2025", vencimento: "05/01/2026", tipo: "Energia Elétrica" },
            { cidade: "São Gabriel da Cachoeira (AM)", valor: 42.15, mes: "Dezembro", emissao: "17/12/2025", vencimento: "05/02/2026", tipo: "Energia Elétrica" },
            { cidade: "Tabatinga", valor: 94.40, mes: "Abril", emissao: "29/05/2025", vencimento: "29/05/2025", pagamento: "17/06/2025", tipo: "Energia Elétrica" },
            { cidade: "Tabatinga", valor: 278.37, mes: "Maio", emissao: "29/05/2025", vencimento: "29/05/2025", pagamento: "17/06/2025", tipo: "Energia Elétrica" },
            { cidade: "Tabatinga", valor: 399.70, mes: "Junho", emissao: "09/06/2025", vencimento: "05/08/2025", pagamento: "06/08/2025", tipo: "Energia Elétrica" },
            { cidade: "Tabatinga", valor: 439.82, mes: "Julho", emissao: "14/07/2025", vencimento: "05/09/2025", pagamento: "05/09/2025", tipo: "Energia Elétrica" },
            { cidade: "Tabatinga", valor: 365.03, mes: "Agosto", emissao: "11/08/2025", vencimento: "05/10/2025", pagamento: "10/09/2025", tipo: "Energia Elétrica" },
            { cidade: "Tabatinga", valor: 421.51, mes: "Setembro", emissao: "11/09/2025", vencimento: "05/11/2025", pagamento: "05/11/2025", tipo: "Energia Elétrica" },
            { cidade: "Tabatinga", valor: 425.72, mes: "Outubro", emissao: "27/10/2025", vencimento: "05/12/2025", pagamento: "25/11/2025", tipo: "Energia Elétrica" },
            { cidade: "Tabatinga", valor: 533.42, mes: "Novembro", emissao: "11/11/2025", vencimento: "05/01/2026", pagamento: "05/12/2025", tipo: "Energia Elétrica" },

            // Água
            { cidade: "Atalaia do Norte", valor: 150.72, mes: "Julho", emissao: "10/07/2025", vencimento: "28/08/2025", pagamento: "28/08/2025", tipo: "Água e Esgoto" },
            { cidade: "Atalaia do Norte", valor: 150.72, mes: "Agosto", emissao: "12/08/2025", vencimento: "28/09/2025", pagamento: "28/09/2025", tipo: "Água e Esgoto" },
            { cidade: "Atalaia do Norte", valor: 150.72, mes: "Setembro", emissao: "03/09/2025", vencimento: "28/10/2025", pagamento: "28/10/2025", tipo: "Água e Esgoto" },
            { cidade: "Atalaia do Norte", valor: 150.72, mes: "Outubro", emissao: "08/10/2025", vencimento: "28/11/2025", pagamento: "28/11/2025", tipo: "Água e Esgoto" },
            { cidade: "Atalaia do Norte", valor: 150.72, mes: "Novembro", emissao: "10/11/2025", vencimento: "28/12/2025", tipo: "Água e Esgoto" },
            { cidade: "Barra do Garças", valor: 168.80, mes: "Agosto", emissao: "06/08/2025", vencimento: "21/08/2025", pagamento: "15/08/2025", tipo: "Água e Esgoto" },
            { cidade: "Barra do Garças", valor: 168.85, mes: "Setembro", emissao: "02/09/2025", vencimento: "22/09/2025", pagamento: "22/09/2025", tipo: "Água e Esgoto" },
            { cidade: "Barra do Garças", valor: 168.80, mes: "Outubro", emissao: "03/10/2025", vencimento: "22/10/2025", pagamento: "22/10/2025", tipo: "Água e Esgoto" },
            { cidade: "Barra do Garças", valor: 168.80, mes: "Novembro", emissao: "07/11/2025", vencimento: "24/11/2025", pagamento: "24/11/2025", tipo: "Água e Esgoto" },
            { cidade: "Barra do Garças", valor: 168.80, mes: "Dezembro", emissao: "04/12/2025", vencimento: "22/12/2025", tipo: "Água e Esgoto" },
            { cidade: "Canarana (MT)", valor: 65.90, mes: "Janeiro", emissao: "05/01/2026", vencimento: "13/01/2026", pagamento: "13/01/2026", tipo: "Água e Esgoto" },
            { cidade: "Tabatinga", valor: 141.38, mes: "Março", emissao: "25/04/2025", vencimento: "28/04/2025", pagamento: "19/05/2025", tipo: "Água e Esgoto" },
            { cidade: "Tabatinga", valor: 194.85, mes: "Abril", emissao: "25/04/2025", vencimento: "28/05/2025", pagamento: "28/05/2025", tipo: "Água e Esgoto" },
            { cidade: "Tabatinga", valor: 194.85, mes: "Maio", emissao: "23/05/2025", vencimento: "28/06/2025", pagamento: "30/06/2025", tipo: "Água e Esgoto" },
            { cidade: "Tabatinga", valor: 194.85, mes: "Junho", emissao: "18/07/2025", vencimento: "28/07/2025", pagamento: "27/08/2025", tipo: "Água e Esgoto" },
            { cidade: "Tabatinga", valor: 194.85, mes: "Julho", emissao: "19/08/2025", vencimento: "28/08/2025", pagamento: "25/08/2025", tipo: "Água e Esgoto" },
            { cidade: "Tabatinga", valor: 194.85, mes: "Agosto", emissao: "19/09/2025", vencimento: "28/09/2025", pagamento: "26/09/2025", tipo: "Água e Esgoto" },
            { cidade: "Tabatinga", valor: 194.85, mes: "Setembro", emissao: "17/10/2025", vencimento: "28/10/2025", pagamento: "28/10/2025", tipo: "Água e Esgoto" },
            { cidade: "Tabatinga", valor: 194.85, mes: "Outubro", emissao: "20/11/2025", vencimento: "28/11/2025", pagamento: "01/12/2025", tipo: "Água e Esgoto" },
            { cidade: "Boa Vista", valor: 237.26, mes: "Setembro", emissao: "12/09/2025", vencimento: "15/10/2025", pagamento: "14/10/2025", tipo: "Água e Esgoto" },
            { cidade: "Boa Vista", valor: 268.94, mes: "Outubro", emissao: "09/10/2025", vencimento: "15/11/2025", pagamento: "28/10/2025", tipo: "Água e Esgoto" },
            { cidade: "Boa Vista", valor: 1439.48, mes: "Novembro", emissao: "17/11/2025", vencimento: "15/12/2025", pagamento: "22/12/2025", tipo: "Água e Esgoto" },
            { cidade: "Boa Vista", valor: 69.57, mes: "Dezembro", emissao: "11/12/2025", vencimento: "15/01/2026", pagamento: "12/01/2026", tipo: "Água e Esgoto" },
            { cidade: "Boa Vista", valor: 98.35, mes: "Janeiro", emissao: "14/01/2026", vencimento: "15/02/2026", tipo: "Água e Esgoto" }
        ];

        // --- Funções Auxiliares React ---
        const parseDate = (d) => {
            if (!d) return null;
            const p = d.split('/');
            return p.length === 3 ? new Date(p[2], p[1]-1, p[0]) : null;
        };

        const formatDate = (date) => (date && date instanceof Date && !isNaN(date)) ? date.toLocaleDateString('pt-BR') : "—";
        const formatCurrency = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);

        // --- Componentes React ---
        const LucideIcon = ({ name, className }) => {
            const iconRef = useRef(null);
            useEffect(() => { if (window.lucide && iconRef.current) window.lucide.createIcons(); }, [name, className]);
            return <span key={name} className="inline-flex"><i ref={iconRef} data-lucide={name} className={className}></i></span>;
        };

        const SortableHeader = ({ label, field, currentSort, onSort, center = false }) => (
            <th className={`px-6 py-5 cursor-pointer hover:text-blue-600 transition-colors ${center ? 'text-center' : ''}`} onClick={() => onSort(field)}>
                <div className={`flex items-center gap-2 ${center ? 'justify-center' : ''}`}>
                    {label}
                    <LucideIcon name="arrow-up-down" className={`w-3 h-3 ${currentSort.key === field ? 'text-blue-600' : 'text-slate-300'}`} />
                </div>
            </th>
        );

        const CardKpi = ({ title, value, iconName, color }) => {
            const colors = {
                blue: 'bg-blue-50 border-blue-100 text-blue-600',
                emerald: 'bg-emerald-50 border-emerald-100 text-emerald-600',
                amber: 'bg-amber-50 border-amber-100 text-amber-600',
                purple: 'bg-purple-50 border-purple-100 text-purple-600',
            };
            return (
                <div className="p-5 rounded-3xl border bg-white shadow-sm hover:translate-y-[-2px] transition-all">
                    <div className="flex justify-between items-start">
                        <div>
                            <p className="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-1">{title}</p>
                            <h4 className="text-xl font-black text-slate-900 tracking-tighter">{value}</h4>
                        </div>
                        <div className={`p-2.5 rounded-2xl ${colors[color].split(' text')[0]} shadow-inner`}>
                            <LucideIcon name={iconName} className={`w-5 h-5 ${colors[color].split('border')[0].replace('bg', 'text')}`} />
                        </div>
                    </div>
                </div>
            );
        };

        // Componente Mapa com Resize Automático
        const LeafletMap = ({ data }) => {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);

            useEffect(() => {
                if (!window.L) return;

                if (!mapInstance.current && mapRef.current) {
                    // AJUSTE: Limitando Zoom e Área do Mapa (React)
                    mapInstance.current = window.L.map(mapRef.current, {
                        minZoom: 4,
                        maxBounds: [[-35, -75], [5, -30]],
                        maxBoundsViscosity: 1.0
                    }).setView([-12.0, -55.0], 4);
                    
                    window.L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; OpenStreetMap', subdomains: 'abcd', maxZoom: 19
                    }).addTo(mapInstance.current);
                }

                if (mapInstance.current) {
                    mapInstance.current.eachLayer((layer) => {
                        if (layer instanceof window.L.Marker) mapInstance.current.removeLayer(layer);
                    });

                    data.forEach(city => {
                        if (!city.lat || !city.lng) return;

                        const getColor = (status) => {
                            if (status === 'Em Atraso') return 'bg-red-500';
                            if (status === 'Pendente') return 'bg-amber-500';
                            if (status === 'No Prazo') return 'bg-emerald-500';
                            return 'bg-slate-200';
                        };

                        // Lógica Z-Index Invertida (Latitude menor = maior Z) para que sul não cubra norte
                        const zIndexVal = Math.floor((90 - city.lat) * 100);

                        // Visualização aprimorada: Texto com fundo + Sombra + Z-index inteligente
                        const html = `
                            <div style="position: relative; display: flex; justify-content: center; z-index: ${zIndexVal}; pointer-events: none;">
                                <div style="position: absolute; bottom: 22px; white-space: nowrap; font-size: 10px; font-weight: 700; color: #334155; background: rgba(255, 255, 255, 0.85); padding: 1px 6px; border-radius: 6px; border: 1px solid rgba(203, 213, 225, 0.6); box-shadow: 0 2px 4px rgba(0,0,0,0.05); backdrop-filter: blur(2px);">
                                    ${city.name}
                                </div>
                                <div style="pointer-events: auto; z-index: ${zIndexVal + 10};" class="flex gap-[2px] bg-white p-1 rounded-full shadow-md border border-slate-200 hover:scale-110 transition-transform cursor-pointer">
                                    <div class="w-2.5 h-2.5 rounded-full ${getColor(city.status['Locação de Imóveis'])}"></div>
                                    <div class="w-2.5 h-2.5 rounded-full ${getColor(city.status['Energia Elétrica'])}"></div>
                                    <div class="w-2.5 h-2.5 rounded-full ${getColor(city.status['Água e Esgoto'])}"></div>
                                </div>
                            </div>
                        `;

                        const tooltipHtml = `
                            <div class="text-[10px] font-bold">
                                <p class="mb-1.5 uppercase tracking-wider text-slate-800 border-b border-slate-200 pb-1.5">${city.name}</p>
                                <div class="flex items-center gap-2 mt-1"><span class="w-2 h-2 rounded-full inline-block ${getColor(city.status['Locação de Imóveis'])}"></span> Locação: ${city.status['Locação de Imóveis']}</div>
                                <div class="flex items-center gap-2 mt-1"><span class="w-2 h-2 rounded-full inline-block ${getColor(city.status['Energia Elétrica'])}"></span> Energia: ${city.status['Energia Elétrica']}</div>
                                <div class="flex items-center gap-2 mt-1"><span class="w-2 h-2 rounded-full inline-block ${getColor(city.status['Água e Esgoto'])}"></span> Água: ${city.status['Água e Esgoto']}</div>
                            </div>
                        `;

                        const icon = window.L.divIcon({ html: html, className: 'custom-map-marker', iconSize: [44, 20], iconAnchor: [22, 10] });

                        window.L.marker([city.lat, city.lng], { icon, zIndexOffset: zIndexVal })
                            .bindTooltip(tooltipHtml, { direction: 'top', className: 'custom-leaflet-tooltip', offset: [0, -10] })
                            .addTo(mapInstance.current);
                    });
                }
            }, [data]);

            // Listener para atualizar mapa quando aba altera
            useEffect(() => {
                const handleResize = () => { if (mapInstance.current) mapInstance.current.invalidateSize(); };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            return (
                <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-200 flex flex-col mb-8 w-full relative">
                    <h3 className="text-[10px] font-black text-slate-400 mb-4 flex items-center gap-2 uppercase tracking-widest justify-center">
                        <LucideIcon name="map" className="text-blue-500 w-4 h-4" /> Distribuição Geográfica (Quadrado)
                    </h3>
                    
                    {/* Container Quadrado Controlado */}
                    <div className="w-full max-w-[800px] aspect-square mx-auto relative border border-slate-100 rounded-3xl shadow-inner overflow-hidden bg-slate-50">
                        <div ref={mapRef} className="w-full h-full z-0"></div>
                        
                        <div className="absolute top-4 right-4 bg-white/95 backdrop-blur-md p-3 rounded-xl border border-slate-200 shadow-sm z-[1000] text-[9px] font-bold uppercase text-slate-500 flex flex-col gap-1.5">
                            <p className="border-b border-slate-200 pb-1 mb-1 text-[8px]">Legenda</p>
                            <div className="flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-slate-400"></span> 1º Locação</div>
                            <div className="flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-slate-400"></span> 2º Energia</div>
                            <div className="flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-slate-400"></span> 3º Água</div>
                        </div>
                    </div>
                </div>
            );
        };

        const AppUtilidades = () => {
            const [activeTab, setActiveTab] = useState('Locação de Imóveis');
            const [filterCity, setFilterCity] = useState('Todas');
            const [statusFilter, setStatusFilter] = useState('Todos');
            const [searchTerm, setSearchTerm] = useState('');
            const [expandedCities, setExpandedCities] = useState(new Set());
            const [sortConfig, setSortConfig] = useState({ key: 'cidade', direction: 'asc' });

            const today = new Date(2026, 1, 11);

            const mapData = useMemo(() => {
                const result = {};
                Object.keys(cityMetadata).forEach(c => {
                    if (cityMetadata[c].lat) {
                        let name = c === 'Boa Vista' ? 'Boa Vista (RR)' : c;
                        if (!result[name]) {
                            result[name] = {
                                name: name, lat: cityMetadata[c].lat, lng: cityMetadata[c].lng,
                                status: { 'Locação de Imóveis': 'Sem Dados', 'Energia Elétrica': 'Sem Dados', 'Água e Esgoto': 'Sem Dados' },
                                items: { 'Locação de Imóveis': [], 'Energia Elétrica': [], 'Água e Esgoto': [] }
                            };
                        }
                    }
                });

                rawData.forEach(item => {
                    let cityName = item.cidade === 'Boa Vista' ? 'Boa Vista (RR)' : item.cidade;
                    if (result[cityName] && result[cityName].items[item.tipo]) result[cityName].items[item.tipo].push(item);
                });

                Object.values(result).forEach(city => {
                    ['Locação de Imóveis', 'Energia Elétrica', 'Água e Esgoto'].forEach(tipo => {
                        const items = city.items[tipo];
                        if (items.length === 0) return;
                        
                        let hasLate = false, hasPending = false;
                        items.forEach(d => {
                            if (d.valor <= 0) return;
                            if (!d.pagamento) hasPending = true;
                            else {
                                const v = parseDate(d.vencimento), p = parseDate(d.pagamento);
                                if (v && p && p > v) hasLate = true;
                            }
                        });

                        if (hasLate) city.status[tipo] = 'Em Atraso';
                        else if (hasPending) city.status[tipo] = 'Pendente';
                        else city.status[tipo] = 'No Prazo';
                    });
                });

                return Object.values(result).filter(city => 
                    city.status['Locação de Imóveis'] !== 'Sem Dados' || 
                    city.status['Energia Elétrica'] !== 'Sem Dados' || 
                    city.status['Água e Esgoto'] !== 'Sem Dados'
                );
            }, []);

            const stats = useMemo(() => {
                const filtered = rawData.filter(d => {
                    if (d.tipo !== activeTab) return false;
                    const matchCity = filterCity === 'Todas' || d.cidade === filterCity;
                    const matchSearch = d.cidade.toLowerCase().includes(searchTerm.toLowerCase()) || (d.mes && d.mes.toLowerCase().includes(searchTerm.toLowerCase()));
                    let matchStatus = true;
                    if (statusFilter !== 'Todos') {
                        const isPaid = !!d.pagamento;
                        const v = parseDate(d.vencimento), p = parseDate(d.pagamento);
                        const isLate = isPaid && v && p && p > v;
                        if (statusFilter === 'Pendente') matchStatus = !isPaid;
                        if (statusFilter === 'Pago') matchStatus = isPaid && !isLate;
                        if (statusFilter === 'Atrasado') matchStatus = isLate;
                    }
                    return matchCity && matchSearch && matchStatus;
                });

                const totalValor = filtered.reduce((acc, curr) => acc + curr.valor, 0);
                const totalPago = filtered.reduce((acc, curr) => curr.pagamento ? acc + curr.valor : acc, 0);
                const ticketMedio = totalValor / (filtered.filter(d => d.valor > 0).length || 1);
                
                const mesesOrdem = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                const porMes = mesesOrdem.map(m => ({
                    name: m, valor: filtered.filter(d => d.mes && d.mes.toLowerCase().includes(m.toLowerCase())).reduce((acc, curr) => acc + curr.valor, 0)
                })).filter(m => m.valor > 0);

                let noPrazo = 0, emAtraso = 0, pendente = 0;
                filtered.forEach(d => {
                    if (d.valor <= 0) return;
                    if (!d.pagamento) pendente++;
                    else {
                        const v = parseDate(d.vencimento), p = parseDate(d.pagamento);
                        if (v && p && p > v) emAtraso++; else noPrazo++;
                    }
                });

                const statusData = [{ name: "No Prazo", value: noPrazo }, { name: "Em Atraso", value: emAtraso }, { name: "Pendente", value: pendente }].filter(s => s.value > 0);

                const groupedMap = filtered.reduce((acc, curr) => {
                    if (!acc[curr.cidade]) acc[curr.cidade] = { cidade: curr.cidade, items: [], lastDueDate: null, lastPaymentDate: null };
                    acc[curr.cidade].items.push(curr);
                    const vDate = parseDate(curr.vencimento);
                    if (vDate && (!acc[curr.cidade].lastDueDate || vDate > parseDate(acc[curr.cidade].lastDueDate))) acc[curr.cidade].lastDueDate = curr.vencimento;
                    const pDate = parseDate(curr.pagamento);
                    if (pDate && (!acc[curr.cidade].lastPaymentDate || pDate > parseDate(acc[curr.cidade].lastPaymentDate))) acc[curr.cidade].lastPaymentDate = curr.pagamento;
                    return acc;
                }, {});

                const groupedArray = Object.values(groupedMap).sort((a, b) => {
                    let vA = a[sortConfig.key], vB = b[sortConfig.key];
                    if (sortConfig.key === 'lastDueDate') { vA = parseDate(vA) || 0; vB = parseDate(vB) || 0; }
                    return sortConfig.direction === 'asc' ? (vA > vB ? 1 : -1) : (vA < vB ? 1 : -1);
                });

                return { totalValor, totalPago, ticketMedio, pendenteValor: totalValor - totalPago, porMes, statusData, groupedArray };
            }, [activeTab, filterCity, searchTerm, statusFilter, sortConfig]);

            const uniqueCitiesList = ['Todas', ...new Set(rawData.filter(d => d.tipo === activeTab).map(d => d.cidade))].sort();

            const toggleCity = (c) => {
                const n = new Set(expandedCities);
                if (n.has(c)) n.delete(c); else n.add(c);
                setExpandedCities(n);
            };

            const handleSort = (key) => {
                setSortConfig(prev => ({ key, direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc' }));
            };

            return (
                <div className="w-full">
                    <div className="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-6">
                        <h2 className="text-xl font-bold text-slate-700 tracking-tight">Detalhes de Locações e Utilidades</h2>
                        <div className="flex bg-slate-100 p-1.5 rounded-2xl border border-slate-200 shadow-inner overflow-x-auto hide-scrollbar whitespace-nowrap">
                            {['Locação de Imóveis', 'Energia Elétrica', 'Água e Esgoto'].map(tab => (
                                <button 
                                    key={tab}
                                    onClick={() => { setActiveTab(tab); setExpandedCities(new Set()); setFilterCity('Todas'); }}
                                    className={`px-5 py-2.5 rounded-xl text-[10px] md:text-xs font-black uppercase tracking-wider transition-all ${activeTab === tab ? 'tab-active-react shadow-md' : 'text-slate-400 hover:text-slate-600'}`}
                                >
                                    {tab}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <CardKpi title={`Total ${activeTab}`} value={formatCurrency(stats.totalValor)} iconName="coins" color="blue" />
                        <CardKpi title="Total Liquidado" value={formatCurrency(stats.totalPago)} iconName="verified" color="emerald" />
                        <CardKpi title="Em Aberto" value={formatCurrency(stats.pendenteValor)} iconName="timer" color="amber" />
                        <CardKpi title="Ticket Médio" value={formatCurrency(stats.ticketMedio)} iconName="activity" color="purple" />
                    </div>

                    <LeafletMap data={mapData} />

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100" key={`chart-bar-${activeTab}`}>
                            <h3 className="text-[10px] font-black text-slate-400 mb-6 flex items-center gap-2 uppercase tracking-widest">
                                <LucideIcon name="trending-up" className="text-blue-500 w-4 h-4" /> Custos por Período
                            </h3>
                            <div className="h-[280px]">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={stats.porMes}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                        <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill: '#64748b', fontSize: 10, fontWeight: 700}} />
                                        <YAxis hide />
                                        <Tooltip cursor={{fill: '#f8fafc'}} />
                                        <Bar dataKey="valor" fill="#005fb2" radius={[12, 12, 0, 0]} barSize={40}>
                                            <LabelList dataKey="valor" position="top" formatter={(v) => `R$ ${v.toFixed(0)}`} style={{ fill: '#475569', fontSize: '9px', fontWeight: '900' }} />
                                        </Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col items-center" key={`chart-pie-${activeTab}`}>
                            <h3 className="text-[10px] font-black text-slate-400 mb-6 flex items-center gap-2 uppercase tracking-widest self-start">
                                <LucideIcon name="shield-alert" className="text-orange-500 w-4 h-4" /> Distribuição de Status
                            </h3>
                            <div className="h-[280px] w-full relative">
                                <ResponsiveContainer width="100%" height="100%">
                                    <PieChart>
                                        <Pie data={stats.statusData} innerRadius={65} outerRadius={95} paddingAngle={8} dataKey="value" stroke="none" label={({name, value}) => `${name}: ${value}`}>
                                            {stats.statusData.map((e, i) => <Cell key={i} fill={COLORS_STATUS[e.name]} />)}
                                        </Pie>
                                        <Tooltip />
                                        <Legend verticalAlign="bottom" height={36} iconType="circle" wrapperStyle={{fontSize: '10px', fontWeight: 'black', textTransform: 'uppercase'}} />
                                    </PieChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-4 mb-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col md:flex-row gap-4 items-center">
                        <div className="relative flex-1 w-full">
                            <LucideIcon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4" />
                            <input 
                                type="text" 
                                placeholder={`Pesquisar faturas de ${activeTab.toLowerCase()}...`}
                                className="pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none w-full text-sm font-medium focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all"
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                        <div className="flex gap-2 w-full md:w-auto">
                            <select className="bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none text-xs font-bold cursor-pointer focus:bg-white shadow-sm" value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)}>
                                <option value="Todos">Status: Todos</option>
                                <option value="Pago">Liquidados</option>
                                <option value="Atrasado">Em Atraso</option>
                                <option value="Pendente">Pendentes</option>
                            </select>
                            <select className="bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none text-xs font-bold cursor-pointer focus:bg-white flex-1 md:flex-none shadow-sm" value={filterCity} onChange={(e) => setFilterCity(e.target.value)}>
                                {uniqueCitiesList.map(c => <option key={c} value={c}>{c}</option>)}
                            </select>
                        </div>
                    </div>

                    <div className="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead>
                                    <tr className="bg-slate-50/80 text-slate-400 text-[10px] uppercase tracking-widest font-black border-b border-slate-200">
                                        <th className="px-6 py-5 w-12"></th>
                                        <SortableHeader label="Localidade" field="cidade" currentSort={sortConfig} onSort={handleSort} />
                                        <SortableHeader label="Docs" field="items" currentSort={sortConfig} onSort={() => {}} center />
                                        <SortableHeader label="Vencimento" field="lastDueDate" currentSort={sortConfig} onSort={handleSort} />
                                        <SortableHeader label="Previsão (+30d)" field="nextDueDate" currentSort={sortConfig} onSort={() => {}} />
                                        <th className="px-6 py-5 text-right font-black">Ciclo Operacional</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {stats.groupedArray.map((city) => {
                                        const isOpen = expandedCities.has(city.cidade);
                                        let nextDate = "—", alert = false;
                                        if (city.lastDueDate) {
                                            const last = parseDate(city.lastDueDate);
                                            const next = new Date(last); next.setDate(last.getDate() + 30);
                                            nextDate = formatDate(next);
                                            if (Math.ceil((next - today) / 86400000) <= 5) alert = true;
                                        }

                                        return (
                                            <React.Fragment key={`${activeTab}-${city.cidade}`}>
                                                <tr className={`hover:bg-slate-50 cursor-pointer transition-all ${isOpen ? 'bg-blue-50/40' : ''}`} onClick={() => toggleCity(city.cidade)}>
                                                    <td className="px-6 py-5 text-center">
                                                        <div className={`p-1.5 rounded-lg border ${isOpen ? 'bg-[#005fb2] text-white border-[#005fb2]' : 'bg-white text-slate-300'}`}>
                                                            <LucideIcon name={isOpen ? "chevron-up" : "chevron-down"} className="w-3 h-3" />
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-5">
                                                        <div className="flex flex-col">
                                                            <span className="font-black text-slate-900 text-sm tracking-tight">{city.cidade}</span>
                                                            <span className="text-[9px] text-slate-400 font-black uppercase tracking-tighter">{cityMetadata[city.cidade]?.uf || "BR"} • {activeTab}</span>
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-5 text-center font-black text-slate-500 text-xs">{city.items.length}</td>
                                                    <td className="px-6 py-5 text-xs font-bold text-slate-600 italic">{city.lastDueDate || "—"}</td>
                                                    <td className="px-6 py-5 text-xs font-black text-slate-700">{nextDate}</td>
                                                    <td className="px-6 py-5 text-right">
                                                        {alert ? (
                                                            <span className="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-red-100 text-red-700 text-[9px] font-black border border-red-200 animate-pulse uppercase">Vencendo</span>
                                                        ) : (
                                                            <span className="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-slate-100 text-slate-500 text-[9px] font-black border border-slate-200 uppercase tracking-tighter">Fluxo Normal</span>
                                                        )}
                                                    </td>
                                                </tr>
                                                {isOpen && (
                                                    <tr>
                                                        <td colSpan="6" className="px-6 py-0 bg-slate-50/30">
                                                            <div className="my-6 rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden mx-4">
                                                                <table className="w-full text-[11px]">
                                                                    <thead className="bg-slate-50 text-slate-400 uppercase font-black border-b border-slate-100">
                                                                        <tr>
                                                                            <th className="px-8 py-3 text-left">Mês Base</th>
                                                                            <th className="px-8 py-3 text-left">Valor Líquido</th>
                                                                            <th className="px-8 py-3 text-left">Vencimento</th>
                                                                            <th className="px-8 py-3 text-left">Liquidação</th>
                                                                            <th className="px-8 py-3 text-right">Parecer</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody className="divide-y divide-slate-50">
                                                                        {city.items.map((item, i) => {
                                                                            const late = item.pagamento && parseDate(item.pagamento) > parseDate(item.vencimento);
                                                                            return (
                                                                                <tr key={`${activeTab}-${city.cidade}-${i}`} className="hover:bg-slate-50 transition-colors">
                                                                                    <td className="px-8 py-4 font-bold text-slate-800 uppercase tracking-tight">{item.mes}</td>
                                                                                    <td className="px-8 py-4 font-black text-slate-900 text-sm">{formatCurrency(item.valor)}</td>
                                                                                    <td className="px-8 py-4 text-slate-400 font-medium italic">{item.vencimento || '—'}</td>
                                                                                    <td className="px-8 py-4 text-slate-400 font-medium italic">{item.pagamento || '—'}</td>
                                                                                    <td className="px-8 py-4 text-right">
                                                                                        {item.valor <= 0 ? <span className="text-[9px] font-black text-slate-300">N/A</span> :
                                                                                         !item.pagamento ? <span className="bg-amber-50 text-amber-600 px-2.5 py-1 rounded-md border border-amber-100 font-black text-[9px] uppercase">Pendente</span> :
                                                                                         late ? <span className="bg-red-50 text-red-600 px-2.5 py-1 rounded-md border border-red-100 font-black text-[9px] uppercase">Atraso</span> :
                                                                                         <span className="bg-emerald-50 text-emerald-600 px-2.5 py-1 rounded-md border border-emerald-100 font-black text-[9px] uppercase">Liquidado</span>}
                                                                                    </td>
                                                                                </tr>
                                                                            );
                                                                        })}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                )}
                                            </React.Fragment>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root-utilidades'));
        root.render(<AppUtilidades />);
    </script>
</body>
</html>
